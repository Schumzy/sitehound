//
//  SiteHound - Easy & powerful website analytics tracking
//
//  Docs: http://www.sitehound.co
//  Source: https://github.com/andyyoung/sitehound
//
//  @author        Andy Young // @andyy // andy@apexa.co.uk
//  @version       0.9.66 - 7th June 2016
//  @licence       GNU GPL v3  http://www.gnu.org/licenses/
//
//  Copyright (C) 2016 Andy Young // andy@apexa.co.uk
//  ~~ 500 Startups Distro Team // #500STRONG // 500.co ~~
//
!function(){function e(){var e=window.sitehound=window.sitehound||[],i=o(e.adaptor);i&&(e.silent||s("Waiting for "+i.klass+" to load.."),i.ready(function(){var e=window.sitehound||[];new t(e,i)}))}function t(e,t){function a(){return P.info("Loaded (version "+c+", adaptor: "+P.adaptor.klass+")"),P.cookieDomain=L(location.hostname),P.debug("Cookie domain: "+P.cookieDomain),g("dnt")?(P.info("Do-not-track cookie present - disabling."),void(P.adaptor="disabled")):(g("logToConsole")&&(P.logToConsole=!0),window.sitehound=P,window.mixpanel&&window.mixpanel.persistence&&document.cookie.indexOf(window.mixpanel.persistence.name+"=")>-1&&d("Warning: Mixpanel cookie detected - update Mixpanel config to use localStorage."),m(),void((e.sniffOnLoad||e.isDone)&&P.sniff()))}function o(e){if(-1!=P.domainsIgnore.indexOf(e))return!0;if(P.domainsIgnoreIPAddress&&/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(e))return!0;for(var t=0;t<P.domainsIgnoreSubdomains.length;t++)if(0==e.indexOf(P.domainsIgnoreSubdomains[t]+"."))return!0;return!1}function u(){P.sniffed=!0,P.page||(P.page=P.detectPage()),P.thisPageTraits["Page Type"]=P.page,l();var e=P.adaptor.userTraits();if(e.createdAt&&(P.globalTraits["Days Since Signup"]=Math.floor((new Date-new Date(e.createdAt))/1e3/60/60/24),P.debug("Days since signup: "+P.globalTraits["Days Since Signup"])),P.userTraits["Email Domain"]?P.userTraits["Email Domain"]=P.userTraits["Email Domain"].match(/[^@]*$/)[0]:(e.Email||e.email||P.userTraits.Email)&&(P.userTraits["Email Domain"]=(e.Email||e.email||P.userTraits.Email).match(/[^@]*$/)[0]),window.FS&&window.FS.getCurrentSessionURL)P.globalTraits["Fullstory URL"]=FS.getCurrentSessionURL();else if(!P.sniffed){var t=window._fs_ready;window._fs_ready=function(){P.adaptor.identify({"Fullstory URL":FS.getCurrentSessionURL()}),"function"==typeof t&&t()}}var i=f(e);if(void 0!==P.overrideReferrer&&(P.thisPageTraits.referrer=P.thisPageTraits.Referrer=P.thisPageTraits.$referrer=P.overrideReferrer),p(),P.trackLandingPage&&(h("Landing",P.landingPageTraits),P.trackLandingPage=!1),P.page){var n=P.page.split("|",2).map(function(e){return e.trim()});n.push(P.pageTraits);h.apply(P,n)}else P.trackAllPages&&h("Unidentified");for(var r=0;r<i.length;r++)P.track(i[r][0],i[r][1])}function l(){var e=g("firstSeen")||(new Date).toISOString();S("firstSeen",e,366);var t=Math.floor((new Date-new Date(e))/1e3/60/60/24);P.globalTraits["First Seen"]=e,P.globalTraits["Days Since First Seen"]=t,P.debug("Visitor first seen: "+e),P.debug("Days since first seen: "+t);var i=g("sessionStarted")||(new Date).toISOString(),r=g("sessionUpdated")||(new Date).toISOString(),a=Math.floor((new Date-new Date(r))/1e3/60);P.debug("Session started: "+i),P.debug("Minutes since last event: "+a);var o=a>P.sessionTimeout;o&&(P.debug("Session timed out - tracking as new session"),i=(new Date).toISOString());var s=Math.floor((new Date-new Date(i))/1e3/60);P.debug("Session duration: "+s),P.globalTraits["Session Started"]=i,P.globalTraits["Minutes Since Session Start"]=s,S("sessionStarted",i),S("sessionUpdated",(new Date).toISOString());var d=(o?0:parseInt(g("pageViews")||0))+1;P.thisPageTraits["Pageviews This Session"]=d,S("pageViews",d),P.debug("Pageviews: "+d);var u,c=document.referrer.match(/https?:\/\/([^\/]+)(\/.*)/),l=null;if(c&&(l=c[1],u=c[2]),l==location.host&&(P.thisPageTraits["Referrer Type"]=P.detectPage(u)),P.isLandingPage=!1,!o){if(d>1)return;P.isLandingPage=!0,P.debug("Detected landing page")}var f=parseInt(g("sessionCount")||0)+1;if(P.globalTraits["Session Count"]=f,S("sessionCount",f,366),P.debug("Session count: "+f),!o){for(var p={},h=["UTM Source","UTM Medium","UTM Campaign","UTM Term","UTM Content","Landing Page","Landing Page Type","Initial Referrer","Initial Referring Domain"],m=0;m<h.length;m++)p[h[m]]=null;var v=k();Object.keys(v).length>0&&(P.debug("utm params:"),P.debug(v),p=n(p,v)),l===location.host?-1!==P.trackReferrerLandingPages.indexOf(u)?(P.debug("Detected known untracked landing page: "+document.referrer),P.trackLandingPage=!0,P.landingPageTraits={path:u,url:document.referrer,$current_url:document.referrer,"Tracked From URL":location.href,referrer:""},p["Landing Page"]=u):document.referrer===location.href?(P.trackLandingPage=!0,p["Landing Page"]=location.pathname):f>1||P.trackDebugWarn("Landing page with local referrer - tracking code not on all pages?"):(P.trackLandingPage=!0,p["Landing Page"]=location.pathname,p["Initial Referrer"]=document.referrer?document.referrer:null,p["Initial Referring Domain"]=l),p["Landing Page"]&&(p["Landing Page Type"]=P.page),p["UTM Source"]||((w(document.URL,"gclid")||w(document.URL,"gclsrc"))&&(p["UTM Source"]="google",p["UTM Medium"]||(p["UTM Medium"]="cpc")),"t.yesware.com"==p["Referring Domain"]&&(p["UTM Source"]="Yesware",p["UTM Medium"]||(p["UTM Medium"]="email")));var T={},b={};for(var y in p)T[y+" [first touch]"]=p[y],b[y+" [last touch]"]=p[y];P.debug("Attribution params:"),P.debug(p),1==f&&(P.debug("..setting first touch params"),P.globalTraits=n(P.globalTraits,I(T))),P.debug("..setting last touch params"),P.globalTraits=n(P.globalTraits,b)}}function f(e){var t=[],i=window.optimizely;if(!i||!i.data)return t;var n=i.data,r=n.state,a=n.sections,o=r.activeExperiments;if(r.redirectExperiment){var s=r.redirectExperiment.experimentId,d=r.activeExperiments.indexOf(s);-1===d&&(o.push(s),P.overrideReferrer=r.redirectExperiment.referrer)}if(!o.length)return t;var u="Optimizely Experiments",g="Optimizely Variations",c=e[u],l=e[g];P.globalTraits[u]=c?"function"==typeof c.indexOf?c:[c]:[],P.globalTraits[g]=l?"function"==typeof l.indexOf?l:[l]:[];for(var f=0;f<o.length;f++){var p=o[f],h=r.variationIdsMap[p][0].toString(),m={"Experiment ID":p,"Experiment Name":n.experiments[p].name,"Experiment First View":!c||!c.indexOf||-1===c.indexOf(p),"Variation ID":h,"Variation Name":r.variationNamesMap[p]};-1===P.globalTraits[u].indexOf(p)&&P.globalTraits[u].push(p);var v=a[p];if(v){m["Section Name"]=v.name,m["Variation ID"]=v.variation_ids.join();for(var T=0;T<v.variation_ids.length;T++)-1===P.globalTraits[g].indexOf(v.variation_ids[T])&&P.globalTraits[g].push(v.variation_ids[T])}else-1===P.globalTraits[g].indexOf(h)&&P.globalTraits[g].push(h);t.push(["Optimizely Experiment Viewed",m])}return P.globalTraits[u].sort(),P.globalTraits[g].sort(),t}function p(){if(P.userId){P.debug("doIdentify(): received userId: "+P.userId);var e={},t=["name","email","createdAt"];for(var r in P.userTraits){for(var a=r.toLowerCase(),o="",s=0;s<t.length;s++)if(a===t[s].toLowerCase()){o=t[s];break}o||(o="User "+i(r)),e[o]=P.userTraits[r]}var d,u=n(P.globalTraits,e);P.adaptor.userId()?(d=P.adaptor.userId(),P.debug("Current userId: "+d)):(P.debug("Anonymous session until now - alias()"),P.adaptor.alias(P.userId),P.adaptor.identify("x")),P.debug("adaptor.identify("+P.userId+", [traits])"),P.userId!==d&&(u=n(u,I({createdAt:(new Date).toISOString()}))),P.adaptor.identify(P.userId,u),P.userId!==d&&(P.debug("userId != currentUserId - Login"),P.track("Login")),S("logged_out","",-100)}else P.adaptor.identify(P.globalTraits),P.detectLogout=void 0===P.detectLogout?void 0!==P.userId:P.detectLogout,P.detectLogout&&!g("logged_out")&&(P.debug("doIdentify(): detecting potential logout.."),P.adaptor.userId()&&(P.track("Logout"),S("logged_out",!0),P.debug("Logout")))}function h(e,t,i){P.debug("Viewed Page: ",[e,t,i]),"object"==typeof i?P.adaptor.page(e,t,P.getTraitsToSend(i)):"object"==typeof t?P.adaptor.page(e,P.getTraitsToSend(t)):t?P.adaptor.page(e,t,P.getTraitsToSend()):P.adaptor.page(e,P.getTraitsToSend())}function m(){b(T(["ready"]))}function v(){b(T())}function T(e){if(P.queue&&P.queue.length){if(!e||!e.length){var t=P.queue;return P.queue=[],t}for(var i=[],n=[],r=0;r<P.queue.length;r++)-1!==e.indexOf(P.queue[r][0])?i.push(P.queue[r]):n.push(P.queue[r]);return P.queue=n,i}}function b(e){for(;e&&e.length>0;){var t=e.shift(),i=t.shift();P[i]&&P[i].apply(P,t)}}function y(e){P.debug("Detected URL change: "+location.href),P.overrideReferrer=e||document.referrer,P.page=void 0;for(var t=P.detectPage(),i=0;i<C.length;i++)C[i](t);P.sniff()}function S(e,t,i,n){var r="";if(0!=i){var a=new Date;a.setTime(a.getTime()+24*i*60*60*1e3),r="expires="+a.toUTCString()}void 0===n&&(n=P.cookieDomain),document.cookie="sh_"+e+"="+t+"; "+r+";path=/"+(n?";domain="+n:"")}function k(){for(var e="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),t="",n={},r=0;r<e.length;++r)t=w(document.URL,e[r]),t.length&&(n["UTM "+i(e[r].slice(4))]=t);return n}function w(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i="[\\?&]"+t+"=([^&#]*)",n=new RegExp(i),r=n.exec(e);return null===r||r&&"string"!=typeof r[1]&&r[1].length?"":decodeURIComponent(r[1]).replace(/\+/g," ")}function I(e){var t=P.adaptor.userTraits(),i={};if("undefined"==typeof t)return e;for(var n in e)n in t||(i[n]=e[n]);return i}function L(e){for(var t=D(e),i=0;i<t.length;++i){var n="__tld__",r="."+t[i];if(S(n,1,0,r),g(n))return S(n,"",-100,r),r}return""}function D(e){var t=e.split("."),i=t[t.length-1],n=[];if(4==t.length&&parseInt(i,10)==i)return n;if(1>=t.length)return n;for(var r=t.length-2;r>=0;--r)n.push(t.slice(r).join("."));return n}var U,O,P=this,C=[];return this.adaptor=t,"object"!=typeof t?void d("adaptor not valid"):(!function(){var t={trackPages:null,page:null,trackAllPages:!1,detectURLChange:!0,detectHashChange:!1,domainsIgnore:["localhost","gtm-msr.appspot.com"],domainsIgnoreIPAddress:!0,domainsIgnoreSubdomains:["staging","test"],trackReferrerLandingPages:[],globalTraits:{},pageTraits:{},thisPageTraits:{},userId:void 0,userTraits:{},detectLogout:void 0,logToConsole:!1,silent:!1,sessionTimeout:30,overrideReferrer:void 0,queue:[],SNIPPET_VERSION:void 0};P.sniffed=!1;for(var i in t)void 0!==e[i]&&(t[i]=e[i]),P[i]=t[i];for(;e.length&&e.pop;)P.queue.unshift(e.pop());P.thisPageTraits["SiteHound library version"]=P.VERSION=c}(),this.sniff=this.done=function(){try{if(P.info("sniff()"),o(location.hostname))return P.info("Ignoring host: "+location.hostname),void(P.adaptor="disabled");if(g("dnt"))return P.info("Do-not-track cookie present - disabling."),void(P.adaptor="disabled");var e=!P.sniffed;if(u(),!e)return;v(),!P.detectURLChange&&!P.detectHashChange||U||(O=location.href,U=setInterval(function(){(P.detectHashChange?location.href!==O:location.href.replace(/#.*$/,"")!==O.replace(/#.*$/,""))&&(y(O),O=location.href)},1e3))}catch(t){this.trackError(t)}},this.deferUntilSniff=function(e,t){return P.sniffed?!1:(t=Array.prototype.slice.call(t),t.unshift(e),P.queue.push(t),P.debug("(Deferring "+e+"() until sniff)"),!0)},this.identify=function(e,t){P.debug("identify",[e,t]),"object"==typeof t?(P.userId=e,P.globalTraits=n(P.globalTraits,t)):"object"==typeof e?P.globalTraits=n(P.globalTraits,e):P.userId=e,P.sniffed&&p()},this.identifyOnce=function(e){P.deferUntilSniff("identifyOnce",arguments)||(P.debug("identifyOnce",e),P.adaptor.identify(I(e)))},this.detectPage=function(e){void 0===e&&(e=location.pathname);for(var t in P.trackPages){var i=P.trackPages[t];Array.isArray(i)||(i=[i]);for(var n=0;n<i.length;++n){var a=i[n];if("function"==typeof a.test){if(a.test(e))return P.debug("Detected page: "+t),t}else if("."===a[0]){if(e===location.pathname&&document.body.className.match(new RegExp("(?:^|\\s)"+r(a.slice(1))+"(?!\\S)")))return P.debug("Detected page: "+t),t}else if(e.replace(/\/$/,"").match(new RegExp("^"+r(a.replace(/\/$/,"")).replace(/\\\*/g,".*")+"$")))return P.debug("Detected page: "+t),t}}},this.getTraitsToSend=function(e){var t=n(P.globalTraits,P.thisPageTraits);return"object"==typeof e?n(t,e):t},this.info=function(e,t){P.silent||s(e,t)},this.debug=function(e,t){P.logToConsole&&s(e,t)},this.doNotTrack=function(e){e="undefined"==typeof e?!0:!!e,e?S("dnt","1",1e3):S("dnt","",-100),P.debug("doNotTrack",e?"true":"false")},this.debugMode=function(e){P.logToConsole=e="undefined"==typeof e?!0:!!e,e?S("logToConsole","1",1e3):S("logToConsole","",-100),P.debug("debugMode",e?"true":"false")},this.onURLChange=this.onUrlChange=function(e){"function"==typeof e?(this.debug("onURLChange()"),C.push(e)):d("onURLChange() called with something that isn't a function")},void a())}function i(e){return"string"==typeof e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):e}function n(e,t){var i={};for(var n in e)i[n]=e[n];for(var n in t)i[n]=t[n];return i}function r(e){return e.replace(/([\/*.?[\]()\-\|])/g,"\\$1")}function a(e,t){f[e]=t,t.prototype.klass=e}function o(e){var t,i;if("object"==typeof e)i=e;else{t=(e||"segment").toLowerCase()||"segment";try{var i=new f[t]}catch(n){return n("adaptor "+t+" could not be loaded"),void n(n.name+"; "+n.message)}}return i}function s(e,t){if(window.console&&console.log)try{"object"==typeof e?JSON&&JSON.stringify&&(e=l+JSON.stringify(e)):e=l+e,t&&JSON&&JSON.stringify&&(e=e+"("+JSON.stringify(t).slice(1).slice(0,-1)+")",t=null),console.log(e),t&&console.log(t)}catch(i){i(i.name+"; "+i.message)}}function d(e){window.console&&(console.error?console.error(l+e):console.log&&console.log(l+"[ERROR] "+e))}function u(e,t,i){for(var n=i||window,r=e.split("."),a=0;a<r.length;a++){if("undefined"==typeof n[r[a]])return void setTimeout(function(){u(e,t,i)},50);n=n[r[a]]}t()}function g(e,t){void 0===t&&(t="sh_");for(var i=t+e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var a=n[r];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(i))return a.substring(i.length,a.length)}return""}var c="0.9.66",l="[SiteHound] ",f={};t.prototype.push=function(e){var t=e.shift();this[t]?this[t].apply(this,e):this.debug("Unrecognised method: "+t)},t.prototype.alias=function(e){this.deferUntilSniff("alias",arguments)||(this.debug("alias",[e]),this.adaptor.alias(e))},t.prototype.track=function(e,t){this.deferUntilSniff("track",arguments)||(t="object"==typeof t?this.getTraitsToSend(t):this.getTraitsToSend(),this.debug("track",[e,t]),this.adaptor.track(e,t))},t.prototype.trackOnce=function(e,t){if(!this.deferUntilSniff("trackOnce",arguments)){this.debug("trackOnce",[e,t]);var i=this.adaptor.userTraits();if(void 0===i["First "+e]){var n={};n["First "+e]=(new Date).toISOString(),this.adaptor.identify(n),this.track(e,t)}}},t.prototype.trackAndCount=function(e,t){if(!this.deferUntilSniff("trackAndCount",arguments)){this.debug("trackAndCount",[e,t]);var i=this.adaptor.userTraits(),n=1;i&&(n=i[e+" Count"]?parseInt(i[e+" Count"])+1:1);var r={};r["First "+e]=(new Date).toISOString(),this.identifyOnce(r);var a={};a[e+" Count"]=n,a["Last "+e]=(new Date).toISOString(),this.adaptor.identify(a),this.track(e,t)}},t.prototype.trackLink=function(e,t){if(!this.deferUntilSniff("trackLink",arguments)){var i={};e&&e.selector&&(i.selector=e.selector),e&&e.length&&(i.length=e.length),this.debug("trackLink",[i,t]),this.adaptor.trackLink(e,t,this.getTraitsToSend())}},t.prototype.trackForm=function(e,t){if(!this.deferUntilSniff("trackForm",arguments)){var i={};e&&e.selector&&(i.selector=e.selector),e&&e.length&&(i.length=e.length),this.debug("trackForm",[i,t]),this.adaptor.trackForm(e,t,this.getTraitsToSend())}},t.prototype.ready=function(e){if("function"==typeof e){var t=this.detectPage();this.debug("ready("+t+")"),e(t)}else d("ready() called with something that isn't a function")},t.prototype.getUserTraits=function(){return result=n(this.adaptor.userTraits(),this.userTraits),this.debug("getUserTraits() returned ",result),result},t.prototype.load=function(e){this.debug("load() called when already loaded"),e&&(this.adaptor=o(e),this.info("Updated adaptor to: "+e.klass))},t.prototype.trackDebugInfo=function(e){this.trackDebug(e,"info")},t.prototype.trackDebugWarn=function(e){this.trackDebug(e,"warn")},t.prototype.trackDebug=function(e,t){t||(t="info"),this.adaptor.track("Tracking Debug",{message:e,level:t,"SiteHound library version":this.VERSION}),this.debug("["+t+"] "+e)},t.prototype.trackError=function(e){this.adaptor.track("Tracking Error",{name:e.name,message:e.message,"SiteHound library version":this.VERSION}),e(e.name+"; "+e.message)},a("disabled",function(){this.ready=this.identify=this.track=this.trackLink=this.trackForm=this.page=this.alias=this.userId=this.userTraits=function(){}}),a("segment",function(){this.ready=function(e){u("analytics.ready",function(){(window.sitehound&&window.sitehound.logToConsole||g("logToConsole"))&&s("window.analytics detected"),analytics.ready(e)})},this.identify=function(e,t){analytics.identify(e,t)},this.track=function(e,t){analytics.track(e,t)},this.trackLink=function(e,t,i){analytics.trackLink(e,t,i)},this.trackForm=function(e,t,i){analytics.trackForm(e,t,i)},this.page=function(e,t,i){analytics.page(e,t,i)},this.alias=function(e){analytics.alias(e)},this.userId=function(){var e=analytics.user();return e?e.id():void 0},this.userTraits=function(){var e=analytics.user(),t=e.traits();return t}}),e()}();