//
//  SiteHound - Easy & powerful website analytics tracking
//
//  Docs: http://www.sitehound.co
//  Source: https://github.com/andyyoung/sitehound
//
//  @author        Andy Young // @andyy // andy@apexa.co.uk
//  @version       0.9.65 - 26th May 2016
//  @licence       GNU GPL v3  http://www.gnu.org/licenses/
//
//  Copyright (C) 2016 Andy Young // andy@apexa.co.uk
//  ~~ 500 Startups Distro Team // #500STRONG // 500.co ~~
//
!function(){function e(){var e=window.sitehound||{},r=o(e.adaptor);r&&r.ready(function(){var e=window.sitehound||{};new t(e,r)})}function t(e,t){function a(){return D.info("Library loaded (version "+s+")"),D.cookieDomain=k(location.hostname),D.debug("Cookie domain: "+D.cookieDomain),y("dnt")?(D.info("Do-not-track cookie present"),void(D.adaptor="disabled")):(y("logToConsole")&&(D.logToConsole=!0),window.sitehound=D,l(),void((e.sniffOnLoad||e.isDone)&&D.sniff()))}function o(e){if(-1!=D.domainsIgnore.indexOf(e))return!0;if(D.domainsIgnoreIPAddress&&/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(e))return!0;for(var t=0;t<D.domainsIgnoreSubdomains.length;t++)if(0==e.indexOf(D.domainsIgnoreSubdomains[t]+"."))return!0;return!1}function d(){D.sniffed=!0,D.page||(D.page=D.detectPage()),D.thisPageTraits["Page Type"]=D.page,u();var e=D.adaptor.userTraits();if(e.createdAt&&(D.globalTraits["Days Since Signup"]=Math.floor((new Date-new Date(e.createdAt))/1e3/60/60/24),D.debug("Days since signup: "+D.globalTraits["Days Since Signup"])),D.userTraits["Email Domain"]?D.userTraits["Email Domain"]=D.userTraits["Email Domain"].match(/[^@]*$/)[0]:(e.Email||e.email||D.userTraits.Email)&&(D.userTraits["Email Domain"]=(e.Email||e.email||D.userTraits.Email).match(/[^@]*$/)[0]),window.FS&&window.FS.getCurrentSessionURL)D.globalTraits["Fullstory URL"]=FS.getCurrentSessionURL();else if(!D.sniffed){var t=window._fs_ready;window._fs_ready=function(){D.adaptor.identify({"Fullstory URL":FS.getCurrentSessionURL()}),"function"==typeof t&&t()}}var i=c(e);if(void 0!==D.overrideReferrer&&(D.thisPageTraits.referrer=D.thisPageTraits.Referrer=D.thisPageTraits.$referrer=D.overrideReferrer),D.userId){D.debug("Received userId: "+D.userId);var e={},a=["name","email","createdAt"];for(var o in D.userTraits){for(var s=o.toLowerCase(),d="",l=0;l<a.length;l++)if(s===a[l].toLowerCase()){d=a[l];break}d||(d="User "+r(o)),e[d]=D.userTraits[o]}var f,h=n(D.globalTraits,e);D.adaptor.userId()?(f=D.adaptor.userId(),D.debug("Current userId: "+f)):(D.debug("Anonymous session until now - alias()"),D.adaptor.alias(D.userId),D.adaptor.identify("x")),D.debug("identify("+D.userId+", [traits])"),D.userId!==f&&(h=n(h,S({createdAt:(new Date).toISOString()}))),D.adaptor.identify(D.userId,h),D.userId!==f&&(D.debug("userId != currentUserId - Login"),D.track("Login")),v("logged_out","",-100)}else D.adaptor.identify(D.globalTraits),D.detectLogout=void 0===D.detectLogout?void 0!==D.userId:D.detectLogout,D.detectLogout&&(D.debug("Detecting potential logout.."),D.adaptor.userId()&&(y("logged_out")||(D.track("Logout"),v("logged_out",!0),D.debug("Logout"))));if(D.trackLandingPage&&(g("Landing",D.landingPageTraits),D.trackLandingPage=!1),D.page){var p=D.page.split("|",2).map(function(e){return e.trim()});p.push(D.pageTraits);g.apply(D,p)}else D.trackAllPages&&g("Unidentified");for(var l=0;l<i.length;l++)D.track(i[l][0],i[l][1])}function u(){var e=y("firstSeen")||(new Date).toISOString();v("firstSeen",e,366);var t=Math.floor((new Date-new Date(e))/1e3/60/60/24);D.globalTraits["First Seen"]=e,D.globalTraits["Days Since First Seen"]=t,D.debug("Visitor first seen: "+e),D.debug("Days since first seen: "+t);var r=y("sessionStarted")||(new Date).toISOString(),i=y("sessionUpdated")||(new Date).toISOString(),a=Math.floor((new Date-new Date(r))/1e3/60),o=Math.floor((new Date-new Date(i))/1e3/60);D.globalTraits["Session Started"]=r,D.globalTraits["Minutes Since Session Start"]=a,D.debug("Session started: "+r),D.debug("Session duration: "+a),D.debug("Minutes since last event: "+o);var s=o>D.sessionTimeout;s&&(D.debug("Session timed out - tracking as new session"),r=(new Date).toISOString()),v("sessionStarted",r),v("sessionUpdated",(new Date).toISOString());var d=(s?0:parseInt(y("pageViews")||0))+1;D.thisPageTraits["Pageviews This Session"]=d,v("pageViews",d),D.debug("Pageviews: "+d);var u,c=document.referrer.match(/https?:\/\/([^\/]+)(\/.*)/),g=null;if(c&&(g=c[1],u=c[2]),g==location.host&&(D.thisPageTraits["Referrer Type"]=D.detectPage(u)),D.isLandingPage=!1,!s){if(d>1)return;D.isLandingPage=!0,D.debug("Detected landing page")}var l=parseInt(y("sessionCount")||0)+1;if(D.globalTraits["Session Count"]=l,v("sessionCount",l,366),D.debug("Session count: "+l),!s){for(var f={},h=["UTM Source","UTM Medium","UTM Campaign","UTM Term","UTM Content","Landing Page","Landing Page Type","Initial Referrer","Initial Referring Domain"],p=0;p<h.length;p++)f[h[p]]=null;var m=T();Object.keys(m).length>0&&(D.debug("utm params:"),D.debug(m),f=n(f,m)),g===location.host?-1!==D.trackReferrerLandingPages.indexOf(u)?(D.debug("Detected known untracked landing page: "+document.referrer),D.trackLandingPage=!0,D.landingPageTraits={path:u,url:document.referrer,$current_url:document.referrer,"Tracked From URL":location.href,referrer:""},f["Landing Page"]=u):document.referrer===location.href?(D.trackLandingPage=!0,f["Landing Page"]=location.pathname):l>1||D.trackDebugWarn("Landing page with local referrer - tracking code not on all pages?"):(D.trackLandingPage=!0,f["Landing Page"]=location.pathname,f["Initial Referrer"]=document.referrer?document.referrer:null,f["Initial Referring Domain"]=g),f["Landing Page"]&&(f["Landing Page Type"]=D.page),f["UTM Source"]||((b(document.URL,"gclid")||b(document.URL,"gclsrc"))&&(f["UTM Source"]="google",f["UTM Medium"]||(f["UTM Medium"]="cpc")),"t.yesware.com"==f["Referring Domain"]&&(f["UTM Source"]="Yesware",f["UTM Medium"]||(f["UTM Medium"]="email")));var k={},w={};for(var I in f)k[I+" [first touch]"]=f[I],w[I+" [last touch]"]=f[I];D.debug("Attribution params:"),D.debug(f),1==l&&(D.debug("..setting first touch params"),D.globalTraits=n(D.globalTraits,S(k))),D.debug("..setting last touch params"),D.globalTraits=n(D.globalTraits,w)}}function c(e){var t=[],r=window.optimizely;if(!r||!r.data)return t;var n=r.data,i=n.state,a=n.sections,o=i.activeExperiments;if(i.redirectExperiment){var s=i.redirectExperiment.experimentId,d=i.activeExperiments.indexOf(s);-1===d&&(o.push(s),D.overrideReferrer=i.redirectExperiment.referrer)}if(o.length>0){var u="Optimizely Experiments",c="Optimizely Variations",g=e[u],l=e[c];D.globalTraits[u]=g?"function"==typeof g.indexOf?g:[g]:[],D.globalTraits[c]=l?"function"==typeof l.indexOf?l:[l]:[];for(var f=0;f<o.length;f++){var h=o[f],p=i.variationIdsMap[h][0].toString(),m={"Experiment ID":h,"Experiment Name":n.experiments[h].name,"Experiment First View":!g||!g.indexOf||-1===g.indexOf(h),"Variation ID":p,"Variation Name":i.variationNamesMap[h]};-1===D.globalTraits[u].indexOf(h)&&D.globalTraits[u].push(h);var v=a[h];if(v){m["Section Name"]=v.name,m["Variation ID"]=v.variation_ids.join();for(var y=0;y<v.variation_ids.length;y++)-1===D.globalTraits[c].indexOf(v.variation_ids[y])&&D.globalTraits[c].push(v.variation_ids[y])}else-1===D.globalTraits[c].indexOf(p)&&D.globalTraits[c].push(p);t.push(["Optimizely Experiment Viewed",m])}}return t}function g(e,t,r){D.debug("Viewed Page: ",[e,t,r]),"object"==typeof r?D.adaptor.page(e,t,D.getTraitsToSend(r)):"object"==typeof t?D.adaptor.page(e,D.getTraitsToSend(t)):t?D.adaptor.page(e,t,D.getTraitsToSend()):D.adaptor.page(e,D.getTraitsToSend())}function l(){p(h(["ready"]))}function f(){p(h())}function h(e){if(D.queue&&D.queue.length){if(!e||!e.length){var t=D.queue;return D.queue=[],t}for(var r=[],n=[],i=0;i<D.queue.length;i++)-1!==e.indexOf(D.queue[i][0])?r.push(D.queue[i]):n.push(D.queue[i]);return D.queue=n,r}}function p(e){for(;e&&e.length>0;){var t=e.shift(),r=t.shift();D[r]&&D[r].apply(D,t)}}function m(e){D.debug("Detected URL change: "+location.href),D.overrideReferrer=e||document.referrer,D.page=void 0;for(var t=D.detectPage(),r=0;r<U.length;r++)U[r](t);D.sniff()}function v(e,t,r,n){var i="";if(0!=r){var a=new Date;a.setTime(a.getTime()+24*r*60*60*1e3),i="expires="+a.toUTCString()}void 0===n&&(n=D.cookieDomain),document.cookie="sh_"+e+"="+t+"; "+i+";path=/"+(n?";domain="+n:"")}function y(e){for(var t="sh_"+e+"=",r=document.cookie.split(";"),n=0;n<r.length;n++){for(var i=r[n];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""}function T(){for(var e="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),t="",n={},i=0;i<e.length;++i)t=b(document.URL,e[i]),t.length&&(n["UTM "+r(e[i].slice(4))]=t);return n}function b(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r="[\\?&]"+t+"=([^&#]*)",n=new RegExp(r),i=n.exec(e);return null===i||i&&"string"!=typeof i[1]&&i[1].length?"":decodeURIComponent(i[1]).replace(/\+/g," ")}function S(e){var t=D.adaptor.userTraits(),r={};if("undefined"==typeof t)return e;for(var n in e)n in t||(r[n]=e[n]);return r}function k(e){for(var t=w(e),r=0;r<t.length;++r){var n="__tld__",i="."+t[r];if(v(n,1,0,i),y(n))return v(n,"",-100,i),i}return""}function w(e){var t=e.split("."),r=t[t.length-1],n=[];if(4==t.length&&parseInt(r,10)==r)return n;if(1>=t.length)return n;for(var i=t.length-2;i>=0;--i)n.push(t.slice(i).join("."));return n}var I,L,D=this,U=[];return this.adaptor=t,"object"==typeof t&&t.check()?(!function(){var t={trackPages:null,page:null,trackAllPages:!1,detectURLChange:!0,detectHashChange:!1,domainsIgnore:["localhost","gtm-msr.appspot.com"],domainsIgnoreIPAddress:!0,domainsIgnoreSubdomains:["staging","test"],trackReferrerLandingPages:[],globalTraits:{},pageTraits:{},thisPageTraits:{},userId:void 0,userTraits:{},detectLogout:void 0,logToConsole:!1,silent:!1,sessionTimeout:30,overrideReferrer:void 0,queue:[],SNIPPET_VERSION:void 0};D.sniffed=!1;for(var r in t)void 0!==e[r]&&(t[r]=e[r]),D[r]=t[r];D.thisPageTraits["SiteHound library version"]=D.VERSION=s}(),this.sniff=this.done=function(){try{if(D.debug("Sniffing.."),o(location.hostname))return D.info("Ignoring host: "+location.hostname),void(D.adaptor="disabled");if(y("dnt"))return D.info("do-not-track cookie present"),void(D.adaptor="disabled");var e=!D.sniffed;if(d(),!e)return;f(),!D.detectURLChange&&!D.detectHashChange||I||(L=location.href,I=setInterval(function(){(D.detectHashChange?location.href!==L:location.href.replace(/#.*$/,"")!==L.replace(/#.*$/,""))&&(m(L),L=location.href)},1e3))}catch(t){this.trackError(t)}},this.deferUntilSniff=function(e,t){return D.sniffed?!1:(t=Array.prototype.slice.call(t),t.unshift(e),D.queue.push(t),D.debug("(Deferring "+e+"() until sniff)"),!0)},this.identifyOnce=function(e){D.deferUntilSniff("identifyOnce",arguments)||(D.debug("identifyOnce",e),D.adaptor.identify(S(e)))},this.detectPage=function(e){void 0===e&&(e=location.pathname);for(var t in D.trackPages){var r=D.trackPages[t];Array.isArray(r)||(r=[r]);for(var n=0;n<r.length;++n){var a=r[n];if("function"==typeof a.test){if(a.test(e))return D.debug("Detected page: "+t),t}else if("."===a[0]){if(e===location.pathname&&document.body.className.match(new RegExp("(?:^|\\s)"+i(a.slice(1))+"(?!\\S)")))return D.debug("Detected page: "+t),t}else if(e.replace(/\/$/,"").match(new RegExp("^"+i(a.replace(/\/$/,"")).replace(/\\\*/g,".*")+"$")))return D.debug("Detected page: "+t),t}}},this.getTraitsToSend=function(e){var t=n(D.globalTraits,D.thisPageTraits);return"object"==typeof e?n(t,e):t},this.info=function(e,t){D.silent||D.log(e,t)},this.debug=function(e,t){D.logToConsole&&D.log(e,t)},this.log=function(e,t){if(window.console&&console.log)try{var r="[SiteHound] ";"object"==typeof e?JSON&&JSON.stringify&&(e=r+JSON.stringify(e)):e=r+e,t&&JSON&&JSON.stringify&&(e=e+"("+JSON.stringify(t).slice(1).slice(0,-1)+")",t=null),console.log(e),t&&console.log(t)}catch(n){D.trackError(n)}},this.doNotTrack=function(e){e="undefined"==typeof e?!0:!!e,e?v("dnt","1",1e3):v("dnt","",-100),D.debug("doNotTrack",e?"true":"false")},this.debugMode=function(e){D.logToConsole=e="undefined"==typeof e?!0:!!e,e?v("logToConsole","1",1e3):v("logToConsole","",-100),D.debug("debugMode",e?"true":"false")},this.onURLChange=this.onUrlChange=function(e){"function"==typeof e?(this.debug("onURLChange()"),U.push(e)):window.console&&console.error&&console.error("[SiteHound] onURLChange() called with something that isn't a function")},void a()):void(window.console&&console.error&&console.error("[SiteHound] adaptor not valid"))}function r(e){return"string"==typeof e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):e}function n(e,t){var r={};for(var n in e)r[n]=e[n];for(var n in t)r[n]=t[n];return r}function i(e){return e.replace(/([\/*.?[\]()\-\|])/g,"\\$1")}function a(e,t){d[e]=t}function o(e){var t,r;if("object"==typeof e)r=e;else{t=(e||"segment").toLowerCase()||"segment";try{var r=new d[t]}catch(n){return void(window.console&&console.error&&(console.error("[SiteHound] adaptor "+t+" could not be loaded"),console.error("[SiteHound] "+n.name+"; "+n.message)))}}return r.check()?r:void(window.console&&console.error&&console.error("[SiteHound] failed to attach to "+(t?t:"adaptor")))}var s="0.9.65",d={};t.prototype.identify=function(e,t){this.deferUntilSniff("identify",arguments)||(this.debug("identify",[e,t]),this.adaptor.identify(e,t))},t.prototype.track=function(e,t){this.deferUntilSniff("track",arguments)||(t="object"==typeof t?this.getTraitsToSend(t):this.getTraitsToSend(),this.debug("track",[e,t]),this.adaptor.track(e,t))},t.prototype.trackOnce=function(e,t){if(!this.deferUntilSniff("trackOnce",arguments)){this.debug("trackOnce",[e,t]);var r=this.adaptor.userTraits();if(void 0===r["First "+e]){var n={};n["First "+e]=(new Date).toISOString(),this.adaptor.identify(n),this.track(e,t)}}},t.prototype.trackAndCount=function(e,t){if(!this.deferUntilSniff("trackAndCount",arguments)){this.debug("trackAndCount",[e,t]);var r=this.adaptor.userTraits(),n=1;r&&(n=r[e+" Count"]?parseInt(r[e+" Count"])+1:1);var i={};i["First "+e]=(new Date).toISOString(),this.identifyOnce(i);var a={};a[e+" Count"]=n,a["Last "+e]=(new Date).toISOString(),this.adaptor.identify(a),this.track(e,t)}},t.prototype.trackLink=function(e,t){if(!this.deferUntilSniff("trackLink",arguments)){var r={};e&&e.selector&&(r.selector=e.selector),e&&e.length&&(r.length=e.length),this.debug("trackLink",[r,t]),this.adaptor.trackLink(e,t,this.getTraitsToSend())}},t.prototype.trackForm=function(e,t){if(!this.deferUntilSniff("trackForm",arguments)){var r={};e&&e.selector&&(r.selector=e.selector),e&&e.length&&(r.length=e.length),this.debug("trackForm",[r,t]),this.adaptor.trackForm(e,t,this.getTraitsToSend())}},t.prototype.ready=function(e){if("function"==typeof e){var t=this.detectPage();this.debug("ready("+t+")"),e(t)}else window.console&&console.error&&console.error("[SiteHound] ready() called with something that isn't a function")},t.prototype.getUserTraits=function(){return result=n(this.adaptor.userTraits(),this.userTraits),this.debug("getUserTraits() returned ",result),result},t.prototype.load=function(e){this.debug("load() called when already loaded"),e&&(this.debug("updating adaptor to: "+e),this.adaptor=o(e))},t.prototype.trackDebugInfo=function(e){this.trackDebug(e,"info")},t.prototype.trackDebugWarn=function(e){this.trackDebug(e,"warn")},t.prototype.trackDebug=function(e,t){t||(t="info"),this.adaptor.track("Tracking Debug",{message:e,level:t,"SiteHound library version":this.VERSION}),this.debug("["+t+"] "+e)},t.prototype.trackError=function(e){this.adaptor.track("Tracking Error",{name:e.name,message:e.message,"SiteHound library version":this.VERSION}),window.console&&console.error&&console.error("[SiteHound] "+e.name+"; "+e.message)},a("disabled",function(){this.check=this.ready=this.identify=this.track=this.trackLink=this.trackForm=this.page=this.alias=this.userId=this.userTraits=function(){}}),a("segment",function(){window.analytics=window.analytics||[];return this.check=function(){return"undefined"!=typeof analytics.ready},this.check()?(this.ready=function(e){analytics.ready(e)},this.identify=function(e,t){analytics.identify(e,t)},this.track=function(e,t){analytics.track(e,t)},this.trackLink=function(e,t,r){analytics.trackLink(e,t,r)},this.trackForm=function(e,t,r){analytics.trackForm(e,t,r)},this.page=function(e,t,r){analytics.page(e,t,r)},this.alias=function(e){analytics.alias(e)},this.userId=function(){var e=analytics.user();return e?e.id():void 0},void(this.userTraits=function(){var e=analytics.user(),t=e.traits();return t})):void(window.console&&console.error&&console.error("[SiteHound] window.analytics is not initialized - ensure analytics.js snippet is included first"))}),e()}();