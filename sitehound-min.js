//
//  SiteHound - Easy & powerful website analytics tracking
//
//  Docs: http://www.sitehound.co
//  Source: https://github.com/andyyoung/sitehound
//
//  @author        Andy Young // @andyy // andy@apexa.co.uk
//  @version       0.9.66 - 7th June 2016
//  @licence       GNU GPL v3  http://www.gnu.org/licenses/
//
//  Copyright (C) 2016 Andy Young // andy@apexa.co.uk
//  ~~ 500 Startups Distro Team // #500STRONG // 500.co ~~
//
!function(){function e(){var e=window.sitehound=window.sitehound||[],i=o(e.adaptor);i&&(e.silent||s("Waiting for the "+i.klass+" adaptor to load.."),i.ready(function(){var e=window.sitehound||[];new t(e,i)}))}function t(e,t){function a(){x.info("Loaded (version "+c+", adaptor: "+x.adaptor.klass+")"),x.cookieDomain=O(location.hostname),x.debug("Cookie domain: "+x.cookieDomain),g("dnt")&&(x.info("Do-not-track cookie present - disabling."),x.adaptor="disabled"),g("logToConsole")&&(x.logToConsole=!0),window.sitehound=x,window.mixpanel&&window.mixpanel.persistence&&document.cookie.indexOf(window.mixpanel.persistence.name+"=")>-1&&d("Warning: Mixpanel cookie detected - update Mixpanel config to use localStorage."),b(),(e.sniffOnLoad||e.isDone)&&x.sniff()}function u(e){if(-1!=x.domainsIgnore.indexOf(e))return!0;if(x.domainsIgnoreIPAddress&&/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(e))return!0;for(var t=0;t<x.domainsIgnoreSubdomains.length;t++)if(0==e.indexOf(x.domainsIgnoreSubdomains[t]+"."))return!0;return!1}function f(){x.sniffed=!0,x.page||(x.page=x.detectPage()),x.thisPageTraits["Page Type"]=x.page,p();var e=x.adaptor.userTraits();if(e.createdAt&&(x.globalTraits["Days Since Signup"]=Math.floor((new Date-new Date(e.createdAt))/1e3/60/60/24),x.debug("Days since signup: "+x.globalTraits["Days Since Signup"])),x.userTraits["Email Domain"]?x.userTraits["Email Domain"]=x.userTraits["Email Domain"].match(/[^@]*$/)[0]:(e.Email||e.email||x.userTraits.Email)&&(x.userTraits["Email Domain"]=(e.Email||e.email||x.userTraits.Email).match(/[^@]*$/)[0]),window.FS&&window.FS.getCurrentSessionURL)x.globalTraits["Fullstory URL"]=FS.getCurrentSessionURL();else if(!x.sniffed){var t=window._fs_ready;window._fs_ready=function(){x.adaptor.identify({"Fullstory URL":FS.getCurrentSessionURL()}),"function"==typeof t&&t()}}var i=h(e);if(void 0!==x.overrideReferrer&&(x.thisPageTraits.referrer=x.thisPageTraits.Referrer=x.thisPageTraits.$referrer=x.overrideReferrer),m(),x.trackLandingPage&&(T("Landing",x.landingPageTraits),x.trackLandingPage=!1),x.page){var n=x.page.split("|",2).map(function(e){return e.trim()});n.push(x.pageTraits);T.apply(x,n)}else x.trackAllPages&&T("Unidentified");for(var r=0;r<i.length;r++)x.track(i[r][0],i[r][1])}function p(){var e=g("firstSeen")||(new Date).toISOString();w("firstSeen",e,366);var t=Math.floor((new Date-new Date(e))/1e3/60/60/24);x.globalTraits["First Seen"]=e,x.globalTraits["Days Since First Seen"]=t,x.debug("Visitor first seen: "+e),x.debug("Days since first seen: "+t);var i=g("sessionStarted")||(new Date).toISOString(),r=g("sessionUpdated")||(new Date).toISOString(),a=Math.floor((new Date-new Date(r))/1e3/60);x.debug("Session started: "+i),x.debug("Minutes since last event: "+a);var o=a>x.sessionTimeout;o&&(x.debug("Session timed out - tracking as new session"),i=(new Date).toISOString());var s=Math.floor((new Date-new Date(i))/1e3/60);x.debug("Session duration: "+s),x.globalTraits["Session Started"]=i,x.globalTraits["Minutes Since Session Start"]=s,w("sessionStarted",i),w("sessionUpdated",(new Date).toISOString());var d=(o?0:parseInt(g("pageViews")||0))+1;x.thisPageTraits["Pageviews This Session"]=d,w("pageViews",d),x.debug("Pageviews: "+d);var u,c=document.referrer.match(/https?:\/\/([^\/]+)(\/.*)/),l=null;if(c&&(l=c[1],u=c[2]),l==location.host&&(x.thisPageTraits["Referrer Type"]=x.detectPage(u)),x.isLandingPage=!1,!o){if(d>1)return;x.isLandingPage=!0,x.debug("Detected landing page")}var f=parseInt(g("sessionCount")||0)+1;if(x.globalTraits["Session Count"]=f,w("sessionCount",f,366),x.debug("Session count: "+f),!o){for(var p={},h=["UTM Source","UTM Medium","UTM Campaign","UTM Term","UTM Content","Landing Page","Landing Page Type","Initial Referrer","Initial Referring Domain"],m=0;m<h.length;m++)p[h[m]]=null;var T=I();Object.keys(T).length>0&&(x.debug("utm params:"),x.debug(T),p=n(p,T)),l===location.host?-1!==x.trackReferrerLandingPages.indexOf(u)?(x.debug("Detected known untracked landing page: "+document.referrer),x.trackLandingPage=!0,x.landingPageTraits={path:u,url:document.referrer,$current_url:document.referrer,"Tracked From URL":location.href,referrer:""},p["Landing Page"]=u):document.referrer===location.href?(x.trackLandingPage=!0,p["Landing Page"]=location.pathname):f>1||x.trackDebugWarn("Landing page with local referrer - tracking code not on all pages?"):(x.trackLandingPage=!0,p["Landing Page"]=location.pathname,p["Initial Referrer"]=document.referrer?document.referrer:null,p["Initial Referring Domain"]=l),p["Landing Page"]&&(p["Landing Page Type"]=x.page),p["UTM Source"]||((L(document.URL,"gclid")||L(document.URL,"gclsrc"))&&(p["UTM Source"]="google",p["UTM Medium"]||(p["UTM Medium"]="cpc")),"t.yesware.com"==p["Referring Domain"]&&(p["UTM Source"]="Yesware",p["UTM Medium"]||(p["UTM Medium"]="email")));var b={},v={};for(var y in p)b[y+" [first touch]"]=p[y],v[y+" [last touch]"]=p[y];x.debug("Attribution params:"),x.debug(p),1==f&&(x.debug("..setting first touch params"),x.globalTraits=n(x.globalTraits,D(b))),x.debug("..setting last touch params"),x.globalTraits=n(x.globalTraits,v)}}function h(e){var t=[],i=window.optimizely;if(!i||!i.data)return t;var n=i.data,r=n.state,a=n.sections,o=r.activeExperiments;if(r.redirectExperiment){var s=r.redirectExperiment.experimentId,d=r.activeExperiments.indexOf(s);-1===d&&(o.push(s),x.overrideReferrer=r.redirectExperiment.referrer)}if(!o.length)return t;var u="Optimizely Experiments",g="Optimizely Variations",c=e[u],l=e[g];x.globalTraits[u]=c?"function"==typeof c.indexOf?c:[c]:[],x.globalTraits[g]=l?"function"==typeof l.indexOf?l:[l]:[];for(var f=0;f<o.length;f++){var p=o[f],h=r.variationIdsMap[p][0].toString(),m={"Experiment ID":p,"Experiment Name":n.experiments[p].name,"Experiment First View":!c||!c.indexOf||-1===c.indexOf(p),"Variation ID":h,"Variation Name":r.variationNamesMap[p]};-1===x.globalTraits[u].indexOf(p)&&x.globalTraits[u].push(p);var T=a[p];if(T){m["Section Name"]=T.name,m["Variation ID"]=T.variation_ids.join();for(var b=0;b<T.variation_ids.length;b++)-1===x.globalTraits[g].indexOf(T.variation_ids[b])&&x.globalTraits[g].push(T.variation_ids[b])}else-1===x.globalTraits[g].indexOf(h)&&x.globalTraits[g].push(h);t.push(["Optimizely Experiment Viewed",m])}return x.globalTraits[u].sort(),x.globalTraits[g].sort(),t}function m(){if(x.userId){x.debug("doIdentify(): received userId: "+x.userId);var e={},t=["name","email","createdAt"];for(var r in x.userTraits){for(var a=r.toLowerCase(),o="",s=0;s<t.length;s++)if(a===t[s].toLowerCase()){o=t[s];break}o||(o="User "+i(r)),e[o]=x.userTraits[r]}var d,u=n(x.globalTraits,e);x.adaptor.userId()?(d=x.adaptor.userId(),x.debug("Current userId: "+d)):(x.debug("Anonymous session until now - alias()"),x.adaptor.alias(x.userId),x.adaptor.identify("x")),x.debug("adaptor.identify("+x.userId+", [traits])"),x.adaptor.identify(x.userId,u),x.userId!==d&&(x.debug("userId != currentUserId - Login"),x.track("Login")),w("logged_out","",-100)}else x.adaptor.identify(x.globalTraits),x.detectLogout=void 0===x.detectLogout?void 0!==x.userId:x.detectLogout,x.detectLogout&&!g("logged_out")&&(x.debug("doIdentify(): detecting potential logout.."),x.adaptor.userId()&&(x.track("Logout"),w("logged_out",!0),x.debug("Logout")))}function T(e,t,i){x.debug("Viewed Page: ",[e,t,i]),"object"==typeof i?x.adaptor.page(e,t,x.getTraitsToSend(i)):"object"==typeof t?x.adaptor.page(e,x.getTraitsToSend(t)):t?x.adaptor.page(e,t,x.getTraitsToSend()):x.adaptor.page(e,x.getTraitsToSend())}function b(){k(y(["ready"]))}function v(){k(y())}function y(e){if(x.queue&&x.queue.length){if(!e||!e.length){var t=x.queue;return x.queue=[],t}for(var i=[],n=[],r=0;r<x.queue.length;r++)-1!==e.indexOf(x.queue[r][0])?i.push(x.queue[r]):n.push(x.queue[r]);return x.queue=n,i}}function k(e){for(;e&&e.length>0;){var t=e.shift(),i=t.shift();x[i]&&x[i].apply(x,t)}}function S(e){x.debug("Detected URL change: "+location.href),x.overrideReferrer=e||document.referrer,x.page=void 0;for(var t=x.detectPage(),i=0;i<E.length;i++)E[i](t);x.sniff()}function w(e,t,i,n){var r="";if(0!=i){var a=new Date;a.setTime(a.getTime()+24*i*60*60*1e3),r="expires="+a.toUTCString()}void 0===n&&(n=x.cookieDomain),document.cookie="sh_"+e+"="+t+"; "+r+";path=/"+(n?";domain="+n:"")}function I(){for(var e="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),t="",n={},r=0;r<e.length;++r)t=L(document.URL,e[r]),t.length&&(n["UTM "+i(e[r].slice(4))]=t);return n}function L(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i="[\\?&]"+t+"=([^&#]*)",n=new RegExp(i),r=n.exec(e);return null===r||r&&"string"!=typeof r[1]&&r[1].length?"":decodeURIComponent(r[1]).replace(/\+/g," ")}function D(e){var t=x.adaptor.userTraits(),i={};if("undefined"==typeof t)return e;for(var n in e)n in t||(i[n]=e[n]);return i}function U(e){x.adaptor=e,l="[SiteHound"+(e&&e.klass?":"+e.klass:"")+"] "}function O(e){for(var t=P(e),i=0;i<t.length;++i){var n="__tld__",r="."+t[i];if(w(n,1,0,r),g(n))return w(n,"",-100,r),r}return""}function P(e){var t=e.split("."),i=t[t.length-1],n=[];if(4==t.length&&parseInt(i,10)==i)return n;if(1>=t.length)return n;for(var r=t.length-2;r>=0;--r)n.push(t.slice(r).join("."));return n}var C,R,x=this,E=[];return U(t),"object"!=typeof this.adaptor?void d("adaptor not valid"):(!function(){var t={trackPages:null,page:null,trackAllPages:!1,detectURLChange:!0,detectHashChange:!1,domainsIgnore:["localhost","gtm-msr.appspot.com"],domainsIgnoreIPAddress:!0,domainsIgnoreSubdomains:["staging","test"],trackReferrerLandingPages:[],globalTraits:{},pageTraits:{},thisPageTraits:{},userId:void 0,userTraits:{},detectLogout:void 0,logToConsole:!1,silent:!1,sessionTimeout:30,overrideReferrer:void 0,queue:[],SNIPPET_VERSION:void 0};x.sniffed=!1;for(var i in t)void 0!==e[i]&&(t[i]=e[i]),x[i]=t[i];for(;e.length&&e.pop;)x.queue.unshift(e.pop());x.thisPageTraits["SiteHound library version"]=x.VERSION=c}(),this.sniff=this.done=function(){try{x.info("sniff()"),u(location.hostname)&&(x.info("Ignoring host: "+location.hostname),x.adaptor="disabled"),g("dnt")&&(x.info("Do-not-track cookie present - disabling."),x.adaptor="disabled");var e=!x.sniffed;if(f(),!e)return;v(),!x.detectURLChange&&!x.detectHashChange||C||(R=location.href,C=setInterval(function(){(x.detectHashChange?location.href!==R:location.href.replace(/#.*$/,"")!==R.replace(/#.*$/,""))&&(S(R),R=location.href)},1e3))}catch(t){this.trackError(t)}},this.deferUntilSniff=function(e,t){return x.sniffed?!1:(t=Array.prototype.slice.call(t),t.unshift(e),x.queue.push(t),x.debug("(Deferring "+e+"() until sniff)"),!0)},this.identify=function(e,t){x.debug("identify",[e,t]),"object"==typeof t?(x.userId=e,x.globalTraits=n(x.globalTraits,t)):"object"==typeof e?x.globalTraits=n(x.globalTraits,e):x.userId=e,x.sniffed&&m()},this.identifyOnce=function(e){x.deferUntilSniff("identifyOnce",arguments)||(x.debug("identifyOnce",e),x.adaptor.identify(D(e)))},this.detectPage=function(e){void 0===e&&(e=location.pathname);for(var t in x.trackPages){var i=x.trackPages[t];Array.isArray(i)||(i=[i]);for(var n=0;n<i.length;++n){var a=i[n];if("function"==typeof a.test){if(a.test(e))return x.debug("Detected page: "+t),t}else if("."===a[0]){if(e===location.pathname&&document.body.className.match(new RegExp("(?:^|\\s)"+r(a.slice(1))+"(?!\\S)")))return x.debug("Detected page: "+t),t}else if(e.replace(/\/$/,"").match(new RegExp("^"+r(a.replace(/\/$/,"")).replace(/\\\*/g,".*")+"$")))return x.debug("Detected page: "+t),t}}},this.getTraitsToSend=function(e){var t=n(x.globalTraits,x.thisPageTraits);return"object"==typeof e?n(t,e):t},this.info=function(e,t){x.silent||s(e,t)},this.debug=function(e,t){x.logToConsole&&s(e,t)},this.doNotTrack=function(e){e="undefined"==typeof e?!0:!!e,e?w("dnt","1",1e3):w("dnt","",-100),x.debug("doNotTrack",e?"true":"false")},this.debugMode=function(e){x.logToConsole=e="undefined"==typeof e?!0:!!e,e?w("logToConsole","1",1e3):w("logToConsole","",-100),x.debug("debugMode",e?"true":"false")},this.onURLChange=this.onUrlChange=function(e){"function"==typeof e?(this.debug("onURLChange()"),E.push(e)):d("onURLChange() called with something that isn't a function")},this.load=function(e){x.debug("load() called when already loaded"),e&&(U(o(e)),x.info("Updated adaptor to: "+x.adaptor.klass))},this.disable=function(){U(o("disabled")),x.info("Disabled tracking")},void a())}function i(e){return"string"==typeof e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):e}function n(e,t){var i={};for(var n in e)i[n]=e[n];for(var n in t)i[n]=t[n];return i}function r(e){return e.replace(/([\/*.?[\]()\-\|])/g,"\\$1")}function a(e,t){f[e]=t,t.prototype.klass=e}function o(e){var t,i;if("object"==typeof e)i=e;else{t=(e||"segment").toLowerCase()||"segment";try{var i=new f[t]}catch(n){return d("adaptor "+t+" could not be loaded"),void d(n.name+"; "+n.message)}}return i}function s(e,t){if(window.console&&console.log)try{"object"==typeof e?JSON&&JSON.stringify&&(e=l+JSON.stringify(e)):e=l+e,t&&JSON&&JSON.stringify&&(e=e+"("+JSON.stringify(t).slice(1).slice(0,-1)+")",t=null),console.log(e),t&&console.log(t)}catch(i){d(i.name+"; "+i.message)}}function d(e){window.console&&(console.error?console.error(l+e):console.log&&console.log(l+"[ERROR] "+e))}function u(e,t,i){for(var n=i||window,r=e.split("."),a=0;a<r.length;a++){if("undefined"==typeof n[r[a]])return void setTimeout(function(){u(e,t,i)},50);n=n[r[a]]}t()}function g(e,t){void 0===t&&(t="sh_");for(var i=t+e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var a=n[r];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(i))return a.substring(i.length,a.length)}return""}var c="0.9.66",l="[SiteHound] ",f={};t.prototype.push=function(e){var t=e.shift();this[t]?this[t].apply(this,e):this.debug("Unrecognised method: "+t)},t.prototype.alias=function(e){this.deferUntilSniff("alias",arguments)||(this.debug("alias",[e]),this.adaptor.alias(e))},t.prototype.track=function(e,t){this.deferUntilSniff("track",arguments)||(t="object"==typeof t?this.getTraitsToSend(t):this.getTraitsToSend(),this.debug("track",[e,t]),this.adaptor.track(e,t))},t.prototype.trackOnce=function(e,t){if(!this.deferUntilSniff("trackOnce",arguments)){this.debug("trackOnce",[e,t]);var i=this.adaptor.userTraits();if(void 0===i["First "+e]){var n={};n["First "+e]=(new Date).toISOString(),this.adaptor.identify(n),this.track(e,t)}}},t.prototype.trackAndCount=function(e,t){if(!this.deferUntilSniff("trackAndCount",arguments)){this.debug("trackAndCount",[e,t]);var i=this.adaptor.userTraits(),n=1;i&&(n=i[e+" Count"]?parseInt(i[e+" Count"])+1:1);var r={};r["First "+e]=(new Date).toISOString(),this.identifyOnce(r);var a={};a[e+" Count"]=n,a["Last "+e]=(new Date).toISOString(),this.adaptor.identify(a),this.track(e,t)}},t.prototype.trackLink=function(e,t){if(!this.deferUntilSniff("trackLink",arguments)){var i={};e&&e.selector&&(i.selector=e.selector),e&&e.length&&(i.length=e.length),this.debug("trackLink",[i,t]),this.adaptor.trackLink(e,t,this.getTraitsToSend())}},t.prototype.trackForm=function(e,t){if(!this.deferUntilSniff("trackForm",arguments)){var i={};e&&e.selector&&(i.selector=e.selector),e&&e.length&&(i.length=e.length),this.debug("trackForm",[i,t]),this.adaptor.trackForm(e,t,this.getTraitsToSend())}},t.prototype.ready=function(e){if("function"==typeof e){var t=this.detectPage();this.debug("ready("+t+")"),e(t)}else d("ready() called with something that isn't a function")},t.prototype.getUserTraits=function(){return result=n(this.adaptor.userTraits(),this.userTraits),this.debug("getUserTraits() returned ",result),result},t.prototype.trackDebugInfo=function(e){this.trackDebug(e,"info")},t.prototype.trackDebugWarn=function(e){this.trackDebug(e,"warn")},t.prototype.trackDebug=function(e,t){t||(t="info"),this.adaptor.track("Tracking Debug",{message:e,level:t,"SiteHound library version":this.VERSION}),this.debug("["+t+"] "+e)},t.prototype.trackError=function(e){this.adaptor.track("Tracking Error",{name:e.name,message:e.message,"SiteHound library version":this.VERSION}),d(e.name+"; "+e.message)},a("disabled",function(){this.ready=function(e){e()},this.identify=this.track=this.trackLink=this.trackForm=this.page=this.alias=this.userId=function(){},this.userTraits=function(){return{}}}),a("segment",function(){this.ready=function(e){u("analytics.ready",function(){(window.sitehound&&window.sitehound.logToConsole||g("logToConsole"))&&s("window.analytics detected"),analytics.ready(e)})},this.identify=function(e,t){analytics.identify(e,t)},this.track=function(e,t){analytics.track(e,t)},this.trackLink=function(e,t,i){analytics.trackLink(e,t,i)},this.trackForm=function(e,t,i){analytics.trackForm(e,t,i)},this.page=function(e,t,i){analytics.page(e,t,i)},this.alias=function(e){analytics.alias(e)},this.userId=function(){var e=analytics.user();return e?e.id():void 0},this.userTraits=function(){var e=analytics.user(),t=e.traits();return t||{}}}),e()}();