//
//  SiteHound - Easy & powerful website analytics tracking
//
//  Docs: http://www.sitehound.co
//  Source: https://github.com/andyyoung/sitehound
//
//  @author        Andy Young // @andyy // andy@apexa.co.uk
//  @version       0.95 - 28th April 2016
//  @licence       GNU GPL v3  http://www.gnu.org/licenses/
//
//  Copyright (C) 2016 Andy Young // andy@apexa.co.uk
//  ~~ 500 Startups Distro Team // #500STRONG // 500.co ~~
//
!function(){function e(){var e=window.sitehound||{},n=o(e.adaptor);n&&n.ready(function(){var e=window.sitehound||{};new t(e,n)})}function t(e,t){function a(e){if(-1!=w.domainsIgnore.indexOf(e))return!0;if(w.domainsIgnoreIPAddress&&/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(e))return!0;for(var t=0;t<w.domainsIgnoreSubdomains.length;t++)if(0==e.indexOf(w.domainsIgnoreSubdomains[0]+"."))return!0;return!1}function o(){w.sniffed=!0,w.page||(w.page=w.detectPage(location.pathname)),w.thisPageTraits["Page Type"]=w.page,void 0!==w.overrideReferrer&&(w.thisPageTraits.referrer=w.thisPageTraits.Referrer=w.thisPageTraits.$referrer=w.overrideReferrer),c();var e=w.adaptor.userTraits();if(e.createdAt&&(w.globalTraits["Days Since Signup"]=Math.floor((new Date-new Date(e.createdAt))/1e3/60/60/24),w.info("Days since signup: "+w.globalTraits["Days Since Signup"])),w.userTraits["Email Domain"]?w.userTraits["Email Domain"]=w.userTraits["Email Domain"].match(/[^@]*$/)[0]:(e.Email||e.email||w.userTraits.Email)&&(w.userTraits["Email Domain"]=(e.Email||e.email||w.userTraits.Email).match(/[^@]*$/)[0]),window.FS&&window.FS.getCurrentSessionURL)w.globalTraits["Fullstory URL"]=FS.getCurrentSessionURL();else if(!w.sniffed){var t=window._fs_ready;window._fs_ready=function(){w.adaptor.identify({"Fullstory URL":FS.getCurrentSessionURL()}),"function"==typeof t&&t()}}if(w.userId){w.info("Received userId: "+w.userId);var e={},r=["name","email","createdAt"];for(var a in w.userTraits){for(var o=a.toLowerCase(),s="",f=0;f<r.length;f++)if(o===r[f].toLowerCase()){s=r[f];break}s||(s="User "+n(a)),e[s]=w.userTraits[a]}var u,l=i(w.globalTraits,e);w.adaptor.userId()?(u=w.adaptor.userId(),w.info("Current userId: "+u)):(w.info("Anonymous session until now - alias()"),w.adaptor.alias(w.userId),w.adaptor.identify("x")),w.info("identify("+w.userId+", [traits])"),w.userId!==u&&(l=i(l,T({createdAt:(new Date).toISOString()}))),w.adaptor.identify(w.userId,l),w.userId!==u&&(w.info("userId != currentUserId - Login"),w.track("Login")),h("logged_out","",-100)}else w.adaptor.identify(w.globalTraits),w.detectLogout=void 0===w.detectLogout?void 0!==w.userId:w.detectLogout,w.detectLogout&&(w.info("Detecting potential logout.."),w.adaptor.userId()&&(p("logged_out")||(w.track("Logout"),h("logged_out",!0),w.info("Logout"))));if(w.trackLandingPage&&d("Landing",w.landingPageTraits),w.page){var g=w.page.split("|",2).map(function(e){return e.trim()});g.push(w.pageTraits);d.apply(w,g)}else w.trackAllPages&&d("Unidentified")}function c(){var e=p("firstSeen")||(new Date).toISOString();h("firstSeen",e,366);var t=Math.floor((new Date-new Date(e))/1e3/60/60/24);w.globalTraits["First Seen"]=e,w.globalTraits["Days Since First Seen"]=t,w.info("Visitor first seen: "+e),w.info("Days since first seen: "+t);var n=p("sessionStarted")||(new Date).toISOString(),r=p("sessionUpdated")||(new Date).toISOString(),a=Math.floor((new Date-new Date(n))/1e3/60),o=Math.floor((new Date-new Date(r))/1e3/60);w.globalTraits["Session Started"]=n,w.globalTraits["Minutes Since Session Start"]=a,w.info("Session started: "+n),w.info("Session duration: "+a),w.info("Minutes since last event: "+o);var s=o>w.sessionTimeout;s&&(w.info("Session timed out - tracking as new session"),n=(new Date).toISOString()),h("sessionStarted",n),h("sessionUpdated",(new Date).toISOString());var c=(s?0:parseInt(p("pageViews")||0))+1;w.thisPageTraits["Pageviews This Session"]=c,h("pageViews",c),w.info("Pageviews: "+c);var d,f=document.referrer.match(/https?:\/\/([^\/]+)(\/.*)/),u=null;if(f&&(u=f[1],d=f[2]),u==location.host&&(w.thisPageTraits["Referrer Type"]=w.detectPage(d)),w.isLandingPage=!1,!s){if(c>1)return;w.isLandingPage=!0,w.info("Detected landing page")}var l=parseInt(p("sessionCount")||0)+1;if(w.globalTraits["Session Count"]=l,h("sessionCount",l,366),w.info("Session count: "+l),!s){for(var g={},v=["UTM Source","UTM Medium","UTM Campaign","UTM Term","UTM Content","Landing Page","Landing Page Type","Initial Referrer","Initial Referring Domain"],S=0;S<v.length;S++)g[v[S]]=null;var k=m();Object.keys(k).length>0&&(w.info("utm params:"),w.info(k),g=i(g,k)),u===location.host?-1!==w.trackReferrerLandingPages.indexOf(d)?(w.info("Detected known untracked landing page: "+document.referrer),w.trackLandingPage=!0,w.landingPageTraits={path:d,url:document.referrer,$current_url:document.referrer,"Tracked From URL":location.href,referrer:""},g["Landing Page"]=d):document.referrer===location.href?(w.trackLandingPage=!0,g["Landing Page"]=location.pathname):l>1||w.trackDebugWarn("Landing page with local referrer - tracking code not on all pages?"):(w.trackLandingPage=!0,g["Landing Page"]=location.pathname,g["Initial Referrer"]=document.referrer?document.referrer:null,g["Initial Referring Domain"]=u),g["Landing Page"]&&(g["Landing Page Type"]=w.page),g["UTM Source"]||((y(document.URL,"gclid")||y(document.URL,"gclsrc"))&&(g["UTM Source"]="google",g["UTM Medium"]||(g["UTM Medium"]="cpc")),"t.yesware.com"==g["Referring Domain"]&&(g["UTM Source"]="Yesware",g["UTM Medium"]||(g["UTM Medium"]="email")));var I={},L={};for(var b in g)I[b+" [first touch]"]=g[b],L[b+" [last touch]"]=g[b];w.info("Attribution params:"),w.info(g),1==l&&(w.info("..setting first touch params"),w.globalTraits=i(w.globalTraits,T(I))),w.info("..setting last touch params"),w.globalTraits=i(w.globalTraits,L)}}function d(e,t,n){"object"==typeof n?w.adaptor.page(e,t,w.getTraitsToSend(n)):"object"==typeof t?w.adaptor.page(e,w.getTraitsToSend(t)):t?w.adaptor.page(e,t,w.getTraitsToSend()):w.adaptor.page(e,w.getTraitsToSend())}function f(){g(l(["ready"]))}function u(){g(l()),g(w.queue)}function l(t){if(e.queue&&e.queue.length){if(!t||!t.length){var n=e.queue;return e.queue=[],n}for(var i=[],r=[],a=0;a<e.queue.length;a++)-1!==t.indexOf(e.queue[a][0])?i.push(e.queue[a]):r.push(e.queue[a]);return e.queue=r,i}}function g(e){for(;e&&e.length>0;){var t=e.shift(),n=t.shift();w[n]&&w[n].apply(w,t)}}function h(e,t,n,i){var r="";if(0!=n){var a=new Date;a.setTime(a.getTime()+24*n*60*60*1e3),r="expires="+a.toUTCString()}void 0===i&&(i=w.cookieDomain),document.cookie="sh_"+e+"="+t+"; "+r+";path=/"+(i?";domain="+i:"")}function p(e){for(var t="sh_"+e+"=",n=document.cookie.split(";"),i=0;i<n.length;i++){for(var r=n[i];" "==r.charAt(0);)r=r.substring(1);if(0==r.indexOf(t))return r.substring(t.length,r.length)}return""}function m(){for(var e="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),t="",i={},r=0;r<e.length;++r)t=y(document.URL,e[r]),t.length&&(i["UTM "+n(e[r].slice(4))]=t);return i}function y(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n="[\\?&]"+t+"=([^&#]*)",i=new RegExp(n),r=i.exec(e);return null===r||r&&"string"!=typeof r[1]&&r[1].length?"":decodeURIComponent(r[1]).replace(/\+/g," ")}function T(e){var t=w.adaptor.userTraits(),n={};for(var i in e)i in t||(n[i]=e[i]);return n}function v(e){for(var t=S(e),n=0;n<t.length;++n){var i="__tld__",r="."+t[n];if(h(i,1,0,r),p(i))return h(i,"",-100,r),r}return""}function S(e){var t=e.split("."),n=t[t.length-1],i=[];if(4==t.length&&parseInt(n,10)==n)return i;if(1>=t.length)return i;for(var r=t.length-2;r>=0;--r)i.push(t.slice(r).join("."));return i}var k={trackPages:null,page:null,trackAllPages:!1,detectURLChange:!0,detectHashChange:!1,domainsIgnore:["localhost","gtm-msr.appspot.com"],domainsIgnoreIPAddress:!0,domainsIgnoreSubdomains:["staging","test"],trackReferrerLandingPages:[],globalTraits:{},pageTraits:{},thisPageTraits:{},userId:void 0,userTraits:{},detectLogout:void 0,logToConsole:!1,sessionTimeout:30,overrideReferrer:void 0,queue:[]},w=this;if(this.sniffed=!1,this.adaptor=t,"object"!=typeof t||!t.check())return void(window.console&&console.error&&console.error("[SiteHound] adaptor not valid"));for(var I in k)void 0!==e[I]&&(k[I]=e[I]),this[I]=k[I];this.thisPageTraits["SiteHound library version"]=this.VERSION=s;var L,b;return this.sniff=this.done=function(){try{if(w.info("Sniffing.."),a(location.hostname))return w.info("Ignoring host: "+location.hostname),void(w.adaptor="disabled");if(p("dnt"))return w.info("do-not-track cookie present"),void(w.adaptor="disabled");f();var e=!w.sniffed;if(o(),"function"==typeof w.adaptor.afterSniff&&w.adaptor.afterSniff(),!e)return;u(),!w.detectURLChange&&!w.detectHashChange||L||(b=location.href,L=setInterval(function(){(w.detectHashChange?location.href!==b:location.href.replace(/#.*$/,"")!==b.replace(/#.*$/,""))&&(w.overrideReferrer=b||document.referrer,b=location.href,w.info("Detected URL change: "+b),w.page=void 0,w.sniff())},1e3))}catch(t){this.trackError(t)}},this.deferUntilSniff=function(e,t){return w.sniffed?!1:(t=Array.prototype.slice.call(t),t.unshift(e),w.queue.push(t),!0)},this.identifyOnce=function(e){w.deferUntilSniff("identifyOnce",arguments)||w.adaptor.identify(w.ignoreExistingTraits(e))},this.detectPage=function(e){void 0===e&&(e=location.pathname);for(var t in w.trackPages){var n=w.trackPages[t];Array.isArray(n)||(n=[n]);for(var i=0;i<n.length;++i){var a=n[i];if("function"==typeof a.test){if(a.test(e))return w.info("Detected page: "+t),t}else if("."===a[0]){if(e===location.pathname&&document.body.className.match(new RegExp("(?:^|\\s)"+r(a.slice(1))+"(?!\\S)")))return w.info("Detected page: "+t),t}else if(e.replace(/\/$/,"").match(new RegExp("^"+r(a.replace(/\/$/,"")).replace(/\\\*/g,".*")+"$")))return w.info("Detected page: "+t),t}}},this.getTraitsToSend=function(e){var t=i(w.globalTraits,w.thisPageTraits);return"object"==typeof e?i(t,e):t},this.info=function(e){w.logToConsole&&window.console&&console.log&&("object"==typeof e?console.log(e):console.log("[SiteHound] "+e))},this.doNotTrack=function(e){e="undefined"==typeof e?!0:!!e,e?h("dnt","1",1e3):h("dnt","",-100)},this.info("Ready (v"+s+")"),this.cookieDomain=v(location.hostname),this.info("Cookie domain: "+this.cookieDomain),p("dnt")?(w.info("do-not-track cookie present"),void(w.adaptor="disabled")):(window.sitehound=this,void(e.isDone&&this.sniff()))}function n(e){return"string"==typeof e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):e}function i(e,t){var n={};for(var i in e)n[i]=e[i];for(var i in t)n[i]=t[i];return n}function r(e){return e.replace(/([\/*.?[\]()\-\|])/g,"\\$1")}function a(e,t){c[e]=t}function o(e){var t,n;if("object"==typeof e)n=e;else{t=(e||"segment").toLowerCase()||"segment";try{var n=new c[t]}catch(i){return void(window.console&&console.error&&(console.error("[SiteHound] adaptor "+t+" could not be loaded"),console.error("[SiteHound] "+i.name+"; "+i.message)))}}return n.check()?n:void(window.console&&console.error&&console.error("[SiteHound] failed to attach to "+(t?t:"adaptor")))}var s="0.95",c={};t.prototype.identify=function(e,t){this.deferUntilSniff("identify",arguments)||this.adaptor.identify(e,t)},t.prototype.track=function(e,t){this.deferUntilSniff("track",arguments)||("object"==typeof t?this.adaptor.track(e,this.getTraitsToSend(t)):this.adaptor.track(e,this.getTraitsToSend()))},t.prototype.trackOnce=function(e,t){if(!this.deferUntilSniff("trackOnce",arguments)){var n=this.adaptor.userTraits();if(void 0===n["First "+e]){var i={};i["First "+e]=(new Date).toISOString(),this.adaptor.identify(i),this.track(e,t)}}},t.prototype.trackAndCount=function(e,t){if(!this.deferUntilSniff("trackAndCount",arguments)){var n=this.adaptor.userTraits(),i=1;n&&(i=n[e+" Count"]?parseInt(n[e+" Count"])+1:1);var r={};r["First "+e]=(new Date).toISOString(),this.identifyOnce(r);var a={};a[e+" Count"]=i,a["Last "+e]=(new Date).toISOString(),this.adaptor.identify(a),this.track(e,t)}},t.prototype.trackLink=function(e,t){this.deferUntilSniff("trackLink",arguments)||this.adaptor.trackLink(e,t,this.getTraitsToSend())},t.prototype.trackForm=function(e,t){this.deferUntilSniff("trackForm",arguments)||this.adaptor.trackForm(e,t,this.getTraitsToSend())},t.prototype.ready=function(e){"function"==typeof e?(this.info("ready()"),e()):window.console&&console.error&&console.error("[SiteHound] ready() called with something that isn't a function")},t.prototype.getUserTraits=function(){return i(this.adaptor.userTraits(),this.userTraits)},t.prototype.load=function(e){this.info("load() called when already loaded"),e&&(this.info("updating adaptor to: "+e),this.adaptor=o(e))},t.prototype.trackDebugInfo=function(e){this.trackDebug(e,"info")},t.prototype.trackDebugWarn=function(e){this.trackDebug(e,"warn")},t.prototype.trackDebug=function(e,t){t||(t="info"),this.adaptor.track("Tracking Debug",{message:e,level:t,"SiteHound library version":this.VERSION}),this.info("["+t+"] "+e)},t.prototype.trackError=function(e){this.adaptor.track("Tracking Error",{name:e.name,message:e.message,"SiteHound library version":this.VERSION}),window.console&&console.error&&console.error("[SiteHound] "+e.name+"; "+e.message)},a("disabled",function(){this.check=this.ready=this.identify=this.track=this.trackLink=this.trackForm=this.page=this.alias=this.userId=this.userTraits=function(){}}),a("segment",function(){window.analytics=window.analytics||[];var e=this;return this.check=function(){return"undefined"!=typeof analytics.ready},this.check()?(this.calledPage=!1,analytics.on("page",function(){e.calledPage=!0}),this.ready=function(e){analytics.ready(e)},this.identify=function(e,t){analytics.identify(e,t)},this.track=function(e,t){analytics.track(e,t)},this.trackLink=function(e,t,n){analytics.trackLink(e,t,n)},this.trackForm=function(e,t,n){analytics.trackForm(e,t,n)},this.page=function(t,n,i){e.calledPage=!0,analytics.page(t,n,i)},this.alias=function(e){analytics.alias(e)},this.userId=function(){var e=analytics.user();return e?e.id():void 0},this.userTraits=function(){var e=analytics.user(),t=e.traits();return t},void(this.afterSniff=function(){e.calledPage||analytics.page()})):void(window.console&&console.error&&console.error("[SiteHound] window.analytics is not initialized - ensure analytics.js snippet is included first"))}),e()}();