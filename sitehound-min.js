//
//  SiteHound - Easy & powerful website analytics tracking
//
//  Docs: http://www.sitehound.co
//  Source: https://github.com/andyyoung/sitehound
//
//  @author        Andy Young // @andyy // andy@apexa.co.uk
//  @version       0.9.69 - 25th Aug 2016
//  @licence       GNU GPL v3  http://www.gnu.org/licenses/
//
//  Copyright (C) 2016 Andy Young // andy@apexa.co.uk
//  ~~ 500 Startups Distro Team // #500STRONG // 500.co ~~
//
!function(){function d(){var a=window.sitehound=window.sitehound||[],b=j(a.adaptor);b&&(a.silent||k("Waiting for the "+b.klass+" adaptor to load.."),b.ready(function(){var a=window.sitehound||[];new e(a,b)}))}function e(c,d){function p(){e.info("Loaded (version "+a+", adaptor: "+e.adaptor.klass+")"),e.cookieDomain=G(location.hostname),e.debug("Cookie domain: "+e.cookieDomain),n("dnt")&&(e.info("Do-not-track cookie present - disabling."),e.adaptor="disabled"),n("logToConsole")&&(e.logToConsole=!0),window.sitehound=e,window.mixpanel&&window.mixpanel.persistence&&document.cookie.indexOf(window.mixpanel.persistence.name+"=")>-1&&l("Warning: Mixpanel cookie detected - update Mixpanel config to use localStorage."),w(),(c.sniffOnLoad||c.isDone)&&e.sniff()}function q(a){if(e.domainsIgnore.indexOf(a)!=-1)return!0;if(e.domainsIgnoreIPAddress&&/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(a))return!0;for(var b=0;b<e.domainsIgnoreSubdomains.length;b++)if(0==a.indexOf(e.domainsIgnoreSubdomains[b]+"."))return!0;return!1}function r(){e.sniffed=!0,e.page||(e.page=e.detectPage()),e.thisPageTraits["Page Type"]=e.page,s();var a=e.adaptor.userTraits();if(a.createdAt&&(e.globalTraits["Days Since Signup"]=Math.floor((new Date-new Date(a.createdAt))/1e3/60/60/24),e.debug("Days since signup: "+e.globalTraits["Days Since Signup"])),e.userTraits["Email Domain"]?e.userTraits["Email Domain"]=e.userTraits["Email Domain"].match(/[^@]*$/)[0]:(a.Email||a.email||e.userTraits.Email)&&(e.userTraits["Email Domain"]=(a.Email||a.email||e.userTraits.Email).match(/[^@]*$/)[0]),window.FS&&window.FS.getCurrentSessionURL)e.globalTraits["Fullstory URL"]=FS.getCurrentSessionURL();else if(!e.sniffed){var b=window._fs_ready;window._fs_ready=function(){e.adaptor.identify({"Fullstory URL":FS.getCurrentSessionURL()}),"function"==typeof b&&b()}}var c=t(a);if(void 0!==e.overrideReferrer&&(e.thisPageTraits.referrer=e.thisPageTraits.Referrer=e.thisPageTraits.$referrer=e.overrideReferrer),u(),e.trackSessionStart&&(e.track("Session Started"),e.trackSessionStart=!1),e.trackLandingPage&&(v("Landing",e.landingPageTraits),e.trackLandingPage=!1),e.page){var d=e.page.split("|",2).map(function(a){return a.trim()});d.push(e.pageTraits);v.apply(e,d)}else e.trackAllPages&&v("Unidentified");for(var g=0;g<c.length;g++)e.track(c[g][0],c[g][1])}function s(){var a=n("firstSeen")||(new Date).toISOString();B("firstSeen",a,366);var b=Math.floor((new Date-new Date(a))/1e3/60/60/24);e.globalTraits["First Seen"]=a,e.globalTraits["Days Since First Seen"]=b,e.debug("Visitor first seen: "+a),e.debug("Days since first seen: "+b);var c=n("sessionStarted")||(new Date).toISOString(),d=n("sessionUpdated")||(new Date).toISOString(),f=Math.floor((new Date-new Date(d))/1e3/60);e.debug("Session started: "+c),e.debug("Minutes since last event: "+f);var h=f>e.sessionTimeout;h&&(e.debug("Session timed out - tracking as new session"),c=(new Date).toISOString());var i=Math.floor((new Date-new Date(c))/1e3/60);e.debug("Session duration: "+i),e.globalTraits["Session Started"]=c,e.globalTraits["Minutes Since Session Start"]=i,B("sessionStarted",c),B("sessionUpdated",(new Date).toISOString());var j=(h?0:parseInt(n("pageViews")||0))+1;e.thisPageTraits["Pageviews This Session"]=j,B("pageViews",j),e.debug("Pageviews: "+j);var m,k=document.referrer.match(/https?:\/\/([^\/]+)(\/.*)/),l=null;if(k&&(l=k[1],m=k[2]),l==location.host&&(e.thisPageTraits["Referrer Type"]=e.detectPage(m)),!h){if(j>1)return;e.debug("Detected landing page")}var o=parseInt(n("sessionCount")||0)+1;if(e.globalTraits["Session Count"]=o,B("sessionCount",o,366),e.debug("Session count: "+o),e.trackSessionStart=h||e.userId,!h){for(var p={},q=["UTM Source","UTM Medium","UTM Campaign","UTM Term","UTM Content","Landing Page","Landing Page Type","Initial Referrer","Initial Referring Domain"],r=0;r<q.length;r++)p[q[r]]=null;var s=C();Object.keys(s).length>0&&(e.debug("utm params:"),e.debug(s),p=g(p,s)),l===location.host?e.trackReferrerLandingPages.indexOf(m)!==-1?(e.debug("Detected known untracked landing page: "+document.referrer),e.trackLandingPage=!0,e.landingPageTraits={path:m,url:document.referrer,$current_url:document.referrer,"Tracked From URL":location.href,referrer:""},p["Landing Page"]=m):document.referrer===location.href?(e.trackLandingPage=!0,p["Landing Page"]=location.pathname):o>1||e.trackDebugWarn("Landing page with local referrer - tracking code not on all pages?"):(e.trackLandingPage=!0,p["Landing Page"]=location.pathname,p["Initial Referrer"]=document.referrer?document.referrer:null,p["Initial Referring Domain"]=l),p["Landing Page"]&&(p["Landing Page Type"]=e.page),p["UTM Source"]||((D(document.URL,"gclid")||D(document.URL,"gclsrc"))&&(p["UTM Source"]="google",p["UTM Medium"]||(p["UTM Medium"]="cpc")),"t.yesware.com"==p["Referring Domain"]&&(p["UTM Source"]="Yesware",p["UTM Medium"]||(p["UTM Medium"]="email")));var t={},u={};for(var v in p)t[v+" [first touch]"]=p[v],u[v+" [last touch]"]=p[v];e.debug("Attribution params:"),e.debug(p),1==o&&(e.debug("..setting first touch params"),e.globalTraits=g(e.globalTraits,E(t))),e.debug("..setting last touch params"),e.globalTraits=g(e.globalTraits,u)}}function t(a){var b=[],c=window.optimizely;if(!c||!c.data)return b;var d=c.data,f=d.state,g=d.sections,h=f.activeExperiments;if(f.redirectExperiment){var i=f.redirectExperiment.experimentId,j=f.activeExperiments.indexOf(i);j===-1&&(h.push(i),e.overrideReferrer=f.redirectExperiment.referrer)}if(!h.length)return b;var k="Optimizely Experiments",l="Optimizely Variations",m=a[k],n=a[l];e.globalTraits[k]=m?"function"==typeof m.sort?m:[m]:[],e.globalTraits[l]=n?"function"==typeof n.sort?n:[n]:[];for(var o=0;o<h.length;o++){var p=h[o],q=f.variationIdsMap[p][0].toString(),r={"Experiment ID":p,"Experiment Name":d.experiments[p].name,"Experiment First View":!m||!m.indexOf||m.indexOf(p)===-1,"Variation ID":q,"Variation Name":f.variationNamesMap[p]};e.globalTraits[k].indexOf(p)===-1&&e.globalTraits[k].push(p);var s=g[p];if(s){r["Section Name"]=s.name,r["Variation ID"]=s.variation_ids.join();for(var t=0;t<s.variation_ids.length;t++)e.globalTraits[l].indexOf(s.variation_ids[t])===-1&&e.globalTraits[l].push(s.variation_ids[t])}else e.globalTraits[l].indexOf(q)===-1&&e.globalTraits[l].push(q);b.push(["Optimizely Experiment Viewed",r])}return e.globalTraits[k].sort(),e.globalTraits[l].sort(),b}function u(){if(e.userId){e.debug("doIdentify(): received userId: "+e.userId);var a={},b=["name","firstName","lastName","email","createdAt"];for(var c in e.userTraits){for(var d=c.toLowerCase(),h="",i=0;i<b.length;i++)if(d===b[i].toLowerCase()){h=b[i];break}h||(h="User "+f(c)),a[h]=e.userTraits[c]}var k,j=g(e.globalTraits,a);e.adaptor.userId()?(k=e.adaptor.userId(),e.debug("Current userId: "+k)):(e.debug("Anonymous session until now - alias()"),e.adaptor.alias(e.userId),e.adaptor.identify("x")),e.debug("adaptor.identify("+e.userId+", [traits])"),e.adaptor.identify(e.userId,j),e.userId!==k&&(e.debug("userId != currentUserId - Login"),e.track("Login")),B("logged_out","",-100)}else e.adaptor.identify(e.globalTraits),e.detectLogout=void 0===e.detectLogout?void 0!==e.userId:e.detectLogout,e.detectLogout&&!n("logged_out")&&(e.debug("doIdentify(): detecting potential logout.."),e.adaptor.userId()&&(e.track("Logout"),B("logged_out",!0),e.debug("Logout")))}function v(a,b,c){e.debug("Viewed Page: ",[a,b,c]),"object"==typeof c?e.adaptor.page(a,b,e.getTraitsToSend(c)):"object"==typeof b?e.adaptor.page(a,e.getTraitsToSend(b)):b?e.adaptor.page(a,b,e.getTraitsToSend()):e.adaptor.page(a,e.getTraitsToSend())}function w(){z(y(["ready","identify"]))}function x(){z(y())}function y(a){if(e.queue&&e.queue.length){if(!a||!a.length){var b=e.queue;return e.queue=[],b}for(var c=[],d=[],f=0;f<e.queue.length;f++)a.indexOf(e.queue[f][0])!==-1?c.push(e.queue[f]):d.push(e.queue[f]);return e.queue=d,c}}function z(a){for(;a&&a.length>0;){var b=a.shift(),c=b.shift();e[c]&&e[c].apply(e,b)}}function A(a){e.debug("Detected URL change: "+location.href),e.overrideReferrer=a||document.referrer,e.page=void 0;for(var b=e.detectPage(),c=0;c<o.length;c++)o[c](b);e.sniff()}function B(a,b,c,d){var f="";if(0!=c){var g=new Date;g.setTime(g.getTime()+24*c*60*60*1e3),f="expires="+g.toUTCString()}void 0===d&&(d=e.cookieDomain),document.cookie="sh_"+a+"="+b+"; "+f+";path=/"+(d?";domain="+d:"")}function C(){for(var a="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),b="",c={},d=0;d<a.length;++d)b=D(document.URL,a[d]),b.length&&(c["UTM "+f(a[d].slice(4))]=b);return c}function D(a,b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c="[\\?&]"+b+"=([^&#]*)",d=new RegExp(c),e=d.exec(a);return null===e||e&&"string"!=typeof e[1]&&e[1].length?"":decodeURIComponent(e[1]).replace(/\+/g," ")}function E(a){var b=e.adaptor.userTraits(),c={};if("undefined"==typeof b)return a;for(var d in a)d in b||(c[d]=a[d]);return c}function F(a){e.adaptor=a,b="[SiteHound"+(a&&a.klass?":"+a.klass:"")+"] "}function G(a){for(var b=H(a),c=0;c<b.length;++c){var d="__tld__",e="."+b[c];if(B(d,1,0,e),n(d))return B(d,"",-100,e),e}return""}function H(a){var b=a.split("."),c=b[b.length-1],d=[];if(4==b.length&&parseInt(c,10)==c)return d;if(1>=b.length)return d;for(var e=b.length-2;0<=e;--e)d.push(b.slice(e).join("."));return d}var i,m,e=this,o=[];return F(c.adaptor&&(c.adaptor.klass||c.adaptor)!==d.klass?j(c.adaptor):d),"object"!=typeof this.adaptor?void l("adaptor not valid"):(!function(){var b={trackPages:null,page:null,trackAllPages:!1,detectURLChange:!0,detectHashChange:!1,domainsIgnore:["localhost","gtm-msr.appspot.com"],domainsIgnoreIPAddress:!0,domainsIgnoreSubdomains:["staging","test"],trackReferrerLandingPages:[],globalTraits:{},pageTraits:{},thisPageTraits:{},userId:void 0,userTraits:{},detectLogout:void 0,logToConsole:!1,silent:!1,sessionTimeout:30,overrideReferrer:void 0,queue:[],SNIPPET_VERSION:void 0};e.sniffed=!1;for(var d in b)void 0!==c[d]&&(b[d]=c[d]),e[d]=b[d];for(;c.length&&c.pop;)e.queue.unshift(c.pop());e.thisPageTraits["SiteHound library version"]=e.VERSION=a}(),this.sniff=this.done=function(){try{e.info("sniff()"),q(location.hostname)&&(e.info("Ignoring host: "+location.hostname),e.adaptor="disabled"),n("dnt")&&(e.info("Do-not-track cookie present - disabling."),e.adaptor="disabled");var a=!e.sniffed;if(r(),!a)return;x(),!e.detectURLChange&&!e.detectHashChange||i||(m=location.href,i=setInterval(function(){(e.detectHashChange?location.href!==m:location.href.replace(/#.*$/,"")!==m.replace(/#.*$/,""))&&(A(m),m=location.href)},1e3))}catch(a){this.trackError(a)}},this.deferUntilSniff=function(a,b){return!e.sniffed&&(b=Array.prototype.slice.call(b),b.unshift(a),e.queue.push(b),e.debug("(Deferring "+a+"() until sniff)"),!0)},this.identify=function(a,b){e.debug("identify",[a,b]),"object"==typeof b?(e.userId=a,e.globalTraits=g(e.globalTraits,b)):"object"==typeof a?e.globalTraits=g(e.globalTraits,a):e.userId=a,e.sniffed&&u()},this.identifyOnce=function(a){e.deferUntilSniff("identifyOnce",arguments)||(e.debug("identifyOnce",a),e.adaptor.identify(E(a)))},this.detectPage=function(a){void 0===a&&(a=location.pathname);for(var b in e.trackPages){var c=e.trackPages[b];Array.isArray(c)||(c=[c]);for(var d=0;d<c.length;++d){var f=c[d];if("function"==typeof f.test){if(f.test(a))return e.debug("Detected page: "+b),b}else if("."===f[0]){if(a===location.pathname&&document.body.className.match(new RegExp("(?:^|\\s)"+h(f.slice(1))+"(?!\\S)")))return e.debug("Detected page: "+b),b}else if(a.replace(/\/$/,"").match(new RegExp("^"+h(f.replace(/\/$/,"")).replace(/\\\*/g,".*")+"$")))return e.debug("Detected page: "+b),b}}},this.getTraitsToSend=function(a){var b=g(e.globalTraits,e.thisPageTraits);return"object"==typeof a?g(b,a):b},this.info=function(a,b){e.silent||k(a,b)},this.debug=function(a,b){e.logToConsole&&k(a,b)},this.doNotTrack=function(a){a="undefined"==typeof a||!!a,a?B("dnt","1",1e3):B("dnt","",-100),e.debug("doNotTrack",a?"true":"false")},this.debugMode=function(a){e.logToConsole=a="undefined"==typeof a||!!a,a?B("logToConsole","1",1e3):B("logToConsole","",-100),e.debug("debugMode",a?"true":"false")},this.onURLChange=this.onUrlChange=function(a){"function"==typeof a?(this.debug("onURLChange()"),o.push(a)):l("onURLChange() called with something that isn't a function")},this.load=function(a){e.debug("load() called when already loaded"),a&&(F(j(a)),e.info("Updated adaptor to: "+e.adaptor.klass))},this.disable=function(){F(j("disabled")),e.info("Disabled tracking")},void p())}function f(a){return"string"==typeof a?a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}):a}function g(a,b){var c={};for(var d in a)c[d]=a[d];for(var d in b)c[d]=b[d];return c}function h(a){return a.replace(/([\/*.?[\]()\-\|])/g,"\\$1")}function i(a,b){c[a]=b,b.prototype.klass=a}function j(a){var b,d;if("object"==typeof a)d=a;else{b=(a||"segment").toLowerCase()||"segment";try{var d=new c[b]}catch(a){return l("adaptor "+b+" could not be loaded"),void l(a.name+"; "+a.message)}}return d}function k(a,c){if(window.console&&console.log)try{"object"==typeof a?JSON&&JSON.stringify&&(a=b+JSON.stringify(a)):a=b+a,c&&JSON&&JSON.stringify&&(a=a+"("+JSON.stringify(c).slice(1).slice(0,-1)+")",c=null),console.log(a),c&&console.log(c)}catch(a){l(a.name+"; "+a.message)}}function l(a){window.console&&(console.error?console.error(b+a):console.log&&console.log(b+"[ERROR] "+a))}function m(a,b,c){for(var d=c||window,e=a.split("."),f=0;f<e.length;f++){if("undefined"==typeof d[e[f]])return void setTimeout(function(){m(a,b,c)},50);d=d[e[f]]}b()}function n(a,b){void 0===b&&(b="sh_");for(var c=b+a+"=",d=document.cookie.split(";"),e=0;e<d.length;e++){for(var f=d[e];" "==f.charAt(0);)f=f.substring(1);if(0==f.indexOf(c))return f.substring(c.length,f.length)}return""}var a="0.9.69",b="[SiteHound] ",c={};e.prototype.push=function(a){var b=a.shift();this[b]?this[b].apply(this,a):this.debug("Unrecognised method: "+b)},e.prototype.alias=function(a){this.deferUntilSniff("alias",arguments)||(this.debug("alias",[a]),this.adaptor.alias(a))},e.prototype.track=function(a,b){function d(a){return a.replace(";","_").replace(":","_")}if(!this.deferUntilSniff("track",arguments)){if(this.debug("track",[a,b]),"object"==typeof b){for(var c in{eventUniqueKey:1,event_unique_key:1,"Event Unique Key":1,"Event unique key":1,"event unique key":1})if(b[c]){c=d(b[c]);var e=d(a)+":"+d(c),f=n("uniqueEvents").split(";");if(f.indexOf(e)!==-1)return void this.debug("already tracked unique event, skipping: "+e);setCookie("uniqueEvents",f.push(e).join(";"));break}b=this.getTraitsToSend(b)}else b=this.getTraitsToSend();this.adaptor.track(a,b)}},e.prototype.trackOnce=function(a,b){if(!this.deferUntilSniff("trackOnce",arguments)){this.debug("trackOnce",[a,b]);var c=this.adaptor.userTraits();if(void 0===c["First "+a]){var d={};d["First "+a]=(new Date).toISOString(),this.adaptor.identify(d),this.track(a,b)}}},e.prototype.trackAndCount=function(a,b){if(!this.deferUntilSniff("trackAndCount",arguments)){this.debug("trackAndCount",[a,b]);var c=this.adaptor.userTraits(),d=1;c&&(d=c[a+" Count"]?parseInt(c[a+" Count"])+1:1);var e={};e["First "+a]=(new Date).toISOString(),this.identifyOnce(e);var f={};f[a+" Count"]=d,f["Last "+a]=(new Date).toISOString(),this.adaptor.identify(f),this.track(a,b)}},e.prototype.trackLink=function(a,b,c){if(!this.deferUntilSniff("trackLink",arguments)){var d={};a&&a.selector&&(d.selector=a.selector),a&&a.length&&(d.length=a.length),this.debug("trackLink",[d,b,c]),this.adaptor.trackLink(a,b,this.getTraitsToSend(c))}},e.prototype.trackForm=function(a,b,c){if(!this.deferUntilSniff("trackForm",arguments)){var d={};a&&a.selector&&(d.selector=a.selector),a&&a.length&&(d.length=a.length),this.debug("trackForm",[d,b,c]),this.adaptor.trackForm(a,b,this.getTraitsToSend(c))}},e.prototype.ready=function(a){if("function"==typeof a){var b=this.detectPage();this.debug("ready("+b+")"),a(b)}else l("ready() called with something that isn't a function")},e.prototype.getUserTraits=function(){return result=g(this.adaptor.userTraits(),this.userTraits),this.debug("getUserTraits() returned ",result),result},e.prototype.trackDebugInfo=function(a){this.trackDebug(a,"info")},e.prototype.trackDebugWarn=function(a){this.trackDebug(a,"warn")},e.prototype.trackDebug=function(a,b){b||(b="info"),this.adaptor.track("Tracking Debug",{message:a,level:b,"SiteHound library version":this.VERSION}),this.debug("["+b+"] "+a)},e.prototype.trackError=function(a){this.adaptor.track("Tracking Error",{name:"object"==typeof a?a.name:"",message:"object"==typeof a?a.message:a,"SiteHound library version":this.VERSION}),l(a.name+"; "+a.message)},i("disabled",function(){this.ready=function(a){a()},this.identify=this.track=this.trackLink=this.trackForm=this.page=this.alias=this.userId=function(){},this.userTraits=function(){return{}}}),i("segment",function(){this.ready=function(a){m("analytics.ready",function(){(window.sitehound&&window.sitehound.logToConsole||n("logToConsole"))&&k("window.analytics detected"),analytics.ready(a)})},this.identify=function(a,b){analytics.identify(a,b)},this.track=function(a,b){analytics.track(a,b)},this.trackLink=function(a,b,c){analytics.trackLink(a,b,c)},this.trackForm=function(a,b,c){analytics.trackForm(a,b,c)},this.page=function(a,b,c){analytics.page(a,b,c)},this.alias=function(a){analytics.alias(a)},this.userId=function(){var a=analytics.user();return a?a.id():void 0},this.userTraits=function(){var a=analytics.user(),b=a.traits();return b||{}}}),d()}();