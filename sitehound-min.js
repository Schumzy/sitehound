//
//  SiteHound - Easy & powerful user, session and event tracking
//  ~~ 500 Startups Distro Team // #500STRONG // 500.co ~~
//
//  @author        Andy Young // @andyy // andy@apexa.co.uk
//  @version       0.82 - 4th April 2016
//  @licence       GNU GPL v3
//
//  Copyright (C) 2016 Andy Young // andy@apexa.co.uk
//
//  This program is free software: you can redistribute it and/or modify
//  it under the terms of the GNU General Public License as published by
//  the Free Software Foundation, either version 3 of the License, or
//  (at your option) any later version.
//
//  This program is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//  GNU General Public License for more details.
//
//  You should have received a copy of the GNU General Public License
//  along with this program.  If not, see <http://www.gnu.org/licenses/>.
//
!function(){function SiteHound(e,t){function r(e){if(-1!=m.domainsIgnore.indexOf(e))return!0;if(m.domainsIgnoreIPAddress&&/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(e))return!0;for(var t=0;t<m.domainsIgnoreSubdomains.length;t++)if(0==e.indexOf(m.domainsIgnoreSubdomains[0]+"."))return!0;return!1}function n(){m.page||(m.page=m.detectPage(location.pathname)),void 0!==m.overrideReferrer&&(m.thisPageTraits.referrer=m.thisPageTraits.Referrer=m.thisPageTraits.$referrer=m.overrideReferrer),i();var e=m.adaptor.userTraits();if(e.createdAt&&(m.globalTraits["Days since signup"]=Math.floor((new Date-new Date(e.createdAt))/1e3/60/60/24),m.info("Days since signup: "+m.globalTraits["Days since signup"])),m.userTraits["email domain"]?m.userTraits["email domain"]=m.userTraits["email domain"].match(/[^@]*$/)[0]:(e.email||m.userTraits.email)&&(m.userTraits["email domain"]=(e.email||m.userTraits.email).match(/[^@]*$/)[0]),window.FS&&window.FS.getCurrentSessionURL)m.globalTraits["Fullstory URL"]=FS.getCurrentSessionURL();else if(!m.sniffed){var t=window._fs_ready;window._fs_ready=function(){m.adaptor.identify({"Fullstory URL":FS.getCurrentSessionURL()}),"function"==typeof t&&t()}}if(m.userId){m.info("Received userId: "+m.userId);var e={};for(var r in m.userTraits)e["User "+r]=m.userTraits[r];var n,a=f(m.globalTraits,e);m.adaptor.userId()?(n=m.adaptor.userId(),m.info("Current userId: "+n)):(m.info("Anonymous session until now - alias()"),m.adaptor.alias(m.userId),m.adaptor.identify("x")),m.info("identify("+m.userId+", [traits])"),m.userId!==n&&(a=f(a,l({createdAt:(new Date).toISOString()}))),m.adaptor.identify(m.userId,a),m.userId!==n&&(m.info("userId != currentUserId - Login"),m.track("Login")),c("logged_out","",-100)}else m.adaptor.identify(m.globalTraits),m.detectLogout=void 0===m.detectLogout?void 0!==m.userId:m.detectLogout,m.detectLogout&&(m.info("Detecting potential logout.."),m.adaptor.userId()&&(u("logged_out")||(m.track("Logout"),c("logged_out",!0),m.info("Logout"))));if(m.trackLandingPage&&o("Landing",m.landingPageTraits),m.page){var s=m.page.split("|",2).map(function(e){return e.trim()});s.push(m.pageTraits);o.apply(m,s)}else m.trackAllPages&&o("Unidentified")}function i(){var e=u("firstSeen")||(new Date).toISOString();c("firstSeen",e,366);var t=Math.floor((new Date-new Date(e))/1e3/60/60/24);m.globalTraits["First seen"]=e,m.globalTraits["Days since first seen"]=t,m.info("Visitor first seen: "+e),m.info("Days since first seen: "+t);var r=u("sessionStarted")||(new Date).toISOString(),n=(u("sessionUpdated")||(new Date).toISOString(),Math.floor((new Date-new Date(r))/1e3/60));m.globalTraits["Session started"]=r,m.globalTraits["Minutes since session start"]=n,m.info("Session started: "+r),m.info("Session duration: "+n);var i=n>m.sessionTimeout;i&&(m.info("Session timed out - tracking as new session"),r=(new Date).toISOString()),c("sessionStarted",r),c("sessionUpdated",(new Date).toISOString());var o=(i?0:parseInt(u("pageViews")||0))+1;if(m.thisPageTraits["Pageviews this session"]=o,c("pageViews",o),m.info("Pageviews: "+o),m.isLandingPage=!1,!i){if(o>1)return;m.isLandingPage=!0,m.info("Detected landing page")}var a=parseInt(u("sessionCount")||0)+1;if(m.globalTraits["Session count"]=a,c("sessionCount",a,366),m.info("Session count: "+a),!i){for(var g={},p=["UTM Source","UTM Medium","UTM Campaign","UTM Term","UTM Content","Landing page","Landing page type","Referrer","Referrer domain","Referrer type"],h=0;h<p.length;h++)g[p[h]]=null;var y=s();Object.keys(y).length>0&&(m.info("utm params:"),m.info(y),g=f(g,y));var S,v=document.referrer.match(/https?:\/\/([^\/]+)(\/.*)/),T=null;v&&(T=v[1],S=v[2]),T===location.host?-1!==m.trackReferrerLandingPages.indexOf(S)?(m.info("Detected known untracked landing page: "+document.referrer),m.trackLandingPage=!0,m.landingPageTraits={path:S,url:document.referrer,$current_url:document.referrer,"Tracked from URL":location.href,referrer:""},g["Landing page"]=S):document.referrer===location.href?(m.trackLandingPage=!0,g["Landing page"]=location.pathname):m.trackDebugWarn("Landing page with local referrer - tracking code not on all pages?"):(m.trackLandingPage=!0,g["Landing page"]=location.pathname,g.Referrer=document.referrer?document.referrer:null,g["Referrer domain"]=T),g["Landing page"]&&(g["Landing page type"]=m.page),g["Referrer domain"]==location.host&&(g["Referrer type"]=m.detectPage(S)),g.utm_source||((d(document.URL,"gclid")||d(document.URL,"gclsrc"))&&(g.utm_source="google",g.utm_medium||(g.utm_medium="cpc")),"t.yesware.com"==g["Referrer domain"]&&(g.utm_source="Yesware",g.utm_medium||(g.utm_medium="email")));var k={},w={};for(var I in g)k[I+" [first touch]"]=g[I],w[I+" [last touch]"]=g[I];m.info("Attribution params:"),m.info(g),1==a&&(m.info("..setting first touch params"),m.globalTraits=f(m.globalTraits,l(k))),m.info("..setting last touch params"),m.globalTraits=f(m.globalTraits,w)}}function o(e,t,r){"object"==typeof r?m.adaptor.page(e,t,m.getTraitsToSend(r)):"object"==typeof t?m.adaptor.page(e,m.getTraitsToSend(t)):t?m.adaptor.page(e,t,m.getTraitsToSend()):m.adaptor.page(e,m.getTraitsToSend())}function a(){function t(e){for(;e&&e.length>0;){var t=e.shift(),r=t.shift();m[r]&&m[r].apply(m,t)}}if(e.queue&&e.queue.length){for(var r=[],n=[],i=0;i<e.queue.length;i++)"ready"===e.queue[i][0]?r.push(e.queue[i][0]):n.push(e.queue[i][0]);t(r),t(n)}}function s(){for(var e="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),t="",r={},n=0;n<e.length;++n)t=d(document.URL,e[n]),t.length&&(r["UTM "+titleCase(e[n].slice(4))]=t);return r}function d(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r="[\\?&]"+t+"=([^&#]*)",n=new RegExp(r),i=n.exec(e);return null===i||i&&"string"!=typeof i[1]&&i[1].length?"":decodeURIComponent(i[1]).replace(/\+/g," ")}function c(e,t,r,n){var i="";if(0!=r){var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3),i="expires="+o.toUTCString()}void 0===n&&(n=m.cookieDomain),document.cookie="sh_"+e+"="+t+"; "+i+";path=/"+(n?";domain="+n:"")}function u(e){for(var t="sh_"+e+"=",r=document.cookie.split(";"),n=0;n<r.length;n++){for(var i=r[n];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""}function f(e,t){var r={};for(var n in e)r[n]=e[n];for(var n in t)r[n]=t[n];return r}function l(e){var t=m.adaptor.userTraits(),r={};for(var n in e)n in t||(r[n]=e[n]);return r}function g(e){for(var t=p(e),r=0;r<t.length;++r){var n="__tld__",i="."+t[r];if(c(n,1,0,i),u(n))return c(n,"",-100,i),i}return""}function p(e){var t=e.split("."),r=t[t.length-1],n=[];if(4==t.length&&parseInt(r,10)==r)return n;if(1>=t.length)return n;for(var i=t.length-2;i>=0;--i)n.push(t.slice(i).join("."));return n}var h={trackPages:null,page:null,trackAllPages:!1,detectURLChange:!0,detectHashChange:!1,domainsIgnore:["localhost"],domainsIgnoreIPAddress:!0,domainsIgnoreSubdomains:["staging","test"],trackReferrerLandingPages:[],globalTraits:{},pageTraits:{},thisPageTraits:{},userId:void 0,userTraits:{},detectLogout:void 0,logToConsole:!1,sessionTimeout:30,overrideReferrer:void 0},m=this;if(this.adaptor=t,"object"!=typeof t||!t.check())return void(window.console&&console.error&&console.error("[SiteHound] adaptor not valid"));for(var y in h)void 0!==e[y]&&(h[y]=e[y]),this[y]=h[y];this.thisPageTraits["SiteHound library version"]=this.VERSION=VERSION;var S,v;return this.sniff=this.done=function(){try{if(m.info("Sniffing.."),r(location.host))return m.info("Ignoring host: "+location.host),void(m.adaptor=new SiteHound_Adaptor_Disabled);if(u("dnt"))return m.info("do-not-track cookie present"),void(m.adaptor=new SiteHound_Adaptor_Disabled);if(n(),"function"==typeof m.adaptor.afterSniff&&m.adaptor.afterSniff(),a(),m.sniffed)return;m.sniffed=!0,!m.detectURLChange&&!m.detectHashChange||S||(v=location.href,S=setInterval(function(){(m.detectHashChange?location.href!==v:location.href.replace(/#.*$/,"")!==v.replace(/#.*$/,""))&&(m.overrideReferrer=v||document.referrer,v=location.href,m.info("Detected URL change: "+v),m.page=void 0,m.sniff())},1e3))}catch(e){this.trackError(e)}},this.identifyOnce=function(e){m.adaptor.identify(m.ignoreExistingTraits(e))},this.detectPage=function(e){void 0===e&&(e=location.pathname);for(var t in m.trackPages){var r=m.trackPages[t];Array.isArray(r)||(r=[r]);for(var n=0;n<r.length;++n){var i=r[n];if("function"==typeof i.test){if(i.test(e))return m.info("Detected page: "+t),t}else if("."===i[0]){if(e===location.pathname&&document.body.className.match(new RegExp("(?:^|\\s)"+RegExp.escape(i.slice(1))+"(?!\\S)")))return m.info("Detected page: "+t),t}else if(i.replace(/\/$/,"")===e.replace(/\/$/,""))return m.info("Detected page: "+t),t}}},this.getTraitsToSend=function(e){return"object"==typeof e?f(m.thisPageTraits,e):m.thisPageTraits},this.info=function(e){m.logToConsole&&window.console&&console.log&&("object"==typeof e?console.log(e):console.log("[SiteHound] "+e))},this.doNotTrack=function(e){e="undefined"==typeof e?!0:!!e,e?c("dnt","1",1e3):c("dnt","",-100)},this.info("Ready (v"+VERSION+")"),this.cookieDomain=g(location.hostname),this.info("Cookie domain: "+this.cookieDomain),u("dnt")?(m.info("do-not-track cookie present"),void(m.adaptor=new SiteHound_Adaptor_Disabled)):void(e.isDone&&this.sniff())}function titleCase(e){return"string"==typeof e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):e}function getAdaptor(adaptor){var adaptorClass,result;if("object"==typeof adaptor)result=adaptor;else{adaptorClass=titleCase(adaptor)||"Segment";try{var result=eval("new SiteHound_Adaptor_"+adaptorClass)}catch(error){return void(window.console&&console.error&&(console.error("[SiteHound] adaptor class SiteHound_Adaptor_"+adaptorClass+" could not be loaded"),console.error("[SiteHound] "+error.name+"; "+error.message)))}}return result.check()?result:void(window.console&&console.error&&console.error("[SiteHound] failed to attach to "+(adaptorClass?adaptorClass:"adaptor")))}function SiteHound_Adaptor_Disabled(){this.check=this.ready=this.identify=this.track=this.trackLink=this.trackForm=this.page=this.alias=this.userId=this.userTraits=function(){}}function SiteHound_Adaptor_Segment(){window.analytics=window.analytics||[];var e=this;return this.check=function(){return"undefined"!=typeof analytics.ready},this.check()?(this.calledPage=!1,analytics.on("page",function(){e.calledPage=!0}),this.ready=function(e){analytics.ready(e)},this.identify=function(e,t){analytics.identify(e,t)},this.track=function(e,t){analytics.track(e,t)},this.trackLink=function(e,t,r){analytics.trackLink(e,t,r)},this.trackForm=function(e,t,r){analytics.trackForm(e,t,r)},this.page=function(t,r,n){e.calledPage=!0,analytics.page(t,r,n)},this.alias=function(e){analytics.alias(e)},this.userId=function(){var e=analytics.user();return e?e.id():void 0},this.userTraits=function(){var e=analytics.user(),t=e.traits();return t},void(this.afterSniff=function(){e.calledPage||analytics.page()})):void(window.console&&console.error&&console.error("[SiteHound] window.analytics is not initialized - ensure analytics.js snippet is included first"))}var VERSION="0.85";!function(){var e=window.sitehound||{},t=getAdaptor(e.adaptor);t.ready(function(){var e=window.sitehound||{},r=new SiteHound(e,t);window.sitehound=r})}(),SiteHound.prototype.identify=function(e,t){this.adaptor.identify(e,t)},SiteHound.prototype.track=function(e,t){"object"==typeof t?this.adaptor.track(e,this.getTraitsToSend(t)):this.adaptor.track(e,this.getTraitsToSend())},SiteHound.prototype.trackOnce=function(e,t){var r=this.adaptor.userTraits();if(void 0===r["First "+e]){var n={};n["First "+e]=(new Date).toISOString(),this.adaptor.identify(n),this.track(e,t)}},SiteHound.prototype.trackAndCount=function(e,t){var r=this.adaptor.userTraits(),n=1;r&&(n=r[e+" Count"]?parseInt(r[e+" Count"])+1:1);var i={};i["First "+e]=(new Date).toISOString(),this.identifyOnce(i);var o={};o[e+" Count"]=n,o["Last "+e]=(new Date).toISOString(),this.adaptor.identify(o),this.track(e,t)},SiteHound.prototype.trackLink=function(e,t){this.adaptor.trackLink(e,t,this.getTraitsToSend())},SiteHound.prototype.trackForm=function(e,t){this.adaptor.trackForm(e,t,this.getTraitsToSend())},SiteHound.prototype.ready=function(e){"function"==typeof e?(this.info("ready()"),e()):window.console&&console.error&&console.error("[SiteHound] ready() called with something that isn't a function")},SiteHound.prototype.load=function(e){this.info("load() called when already loaded"),e&&(this.info("updating adaptor to: "+e),this.adaptor=getAdaptor(e))},SiteHound.prototype.trackDebugInfo=function(e){this.trackDebug(e,"info")},SiteHound.prototype.trackDebugWarn=function(e){this.trackDebug(e,"warn")},SiteHound.prototype.trackDebug=function(e,t){t||(t="info"),this.adaptor.track("Tracking Debug",{message:e,level:t,"SiteHound library version":this.VERSION}),this.info("["+t+"] "+e)},SiteHound.prototype.trackError=function(e){this.adaptor.track("Tracking Error",{name:e.name,message:e.message,"SiteHound library version":this.VERSION}),window.console&&console.error&&console.error("[SiteHound] "+e.name+"; "+e.message)}}();