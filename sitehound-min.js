//
//  SiteHound - Easy & powerful user, session and event tracking
//  ~~ 500 Startups Distro Team // #500STRONG // 500.co ~~
//
//  @author        Andy Young // @andyy // andy@apexa.co.uk
//  @version       0.88 - 4th April 2016
//  @licence       GNU GPL v3
//
//  Copyright (C) 2016 Andy Young // andy@apexa.co.uk
//
//  This program is free software: you can redistribute it and/or modify
//  it under the terms of the GNU General Public License as published by
//  the Free Software Foundation, either version 3 of the License, or
//  (at your option) any later version.
//
//  This program is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//  GNU General Public License for more details.
//
//  You should have received a copy of the GNU General Public License
//  along with this program.  If not, see <http://www.gnu.org/licenses/>.
//
!function(){function SiteHound(e,t){function n(e){if(-1!=v.domainsIgnore.indexOf(e))return!0;if(v.domainsIgnoreIPAddress&&/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(e))return!0;for(var t=0;t<v.domainsIgnoreSubdomains.length;t++)if(0==e.indexOf(v.domainsIgnoreSubdomains[0]+"."))return!0;return!1}function r(){v.page||(v.page=v.detectPage(location.pathname)),void 0!==v.overrideReferrer&&(v.thisPageTraits.referrer=v.thisPageTraits.Referrer=v.thisPageTraits.$referrer=v.overrideReferrer),i();var e=v.adaptor.userTraits();if(e.createdAt&&(v.globalTraits["Days since signup"]=Math.floor((new Date-new Date(e.createdAt))/1e3/60/60/24),v.info("Days since signup: "+v.globalTraits["Days since signup"])),v.userTraits["email domain"]?v.userTraits["email domain"]=v.userTraits["email domain"].match(/[^@]*$/)[0]:(e.email||v.userTraits.email)&&(v.userTraits["email domain"]=(e.email||v.userTraits.email).match(/[^@]*$/)[0]),window.FS&&window.FS.getCurrentSessionURL)v.globalTraits["Fullstory URL"]=FS.getCurrentSessionURL();else if(!v.sniffed){var t=window._fs_ready;window._fs_ready=function(){v.adaptor.identify({"Fullstory URL":FS.getCurrentSessionURL()}),"function"==typeof t&&t()}}if(v.userId){v.info("Received userId: "+v.userId);var e={};for(var n in v.userTraits)e["User "+n]=v.userTraits[n];var r,o=p(v.globalTraits,e);v.adaptor.userId()?(r=v.adaptor.userId(),v.info("Current userId: "+r)):(v.info("Anonymous session until now - alias()"),v.adaptor.alias(v.userId),v.adaptor.identify("x")),v.info("identify("+v.userId+", [traits])"),v.userId!==r&&(o=p(o,h({createdAt:(new Date).toISOString()}))),v.adaptor.identify(v.userId,o),v.userId!==r&&(v.info("userId != currentUserId - Login"),v.track("Login")),l("logged_out","",-100)}else v.adaptor.identify(v.globalTraits),v.detectLogout=void 0===v.detectLogout?void 0!==v.userId:v.detectLogout,v.detectLogout&&(v.info("Detecting potential logout.."),v.adaptor.userId()&&(g("logged_out")||(v.track("Logout"),l("logged_out",!0),v.info("Logout"))));if(v.trackLandingPage&&a("Landing",v.landingPageTraits),v.page){var s=v.page.split("|",2).map(function(e){return e.trim()});s.push(v.pageTraits);a.apply(v,s)}else v.trackAllPages&&a("Unidentified")}function i(){var e=g("firstSeen")||(new Date).toISOString();l("firstSeen",e,366);var t=Math.floor((new Date-new Date(e))/1e3/60/60/24);v.globalTraits["First seen"]=e,v.globalTraits["Days since first seen"]=t,v.info("Visitor first seen: "+e),v.info("Days since first seen: "+t);var n=g("sessionStarted")||(new Date).toISOString(),r=(g("sessionUpdated")||(new Date).toISOString(),Math.floor((new Date-new Date(n))/1e3/60));v.globalTraits["Session started"]=n,v.globalTraits["Minutes since session start"]=r,v.info("Session started: "+n),v.info("Session duration: "+r);var i=r>v.sessionTimeout;i&&(v.info("Session timed out - tracking as new session"),n=(new Date).toISOString()),l("sessionStarted",n),l("sessionUpdated",(new Date).toISOString());var a=(i?0:parseInt(g("pageViews")||0))+1;if(v.thisPageTraits["Pageviews this session"]=a,l("pageViews",a),v.info("Pageviews: "+a),v.isLandingPage=!1,!i){if(a>1)return;v.isLandingPage=!0,v.info("Detected landing page")}var o=parseInt(g("sessionCount")||0)+1;if(v.globalTraits["Session count"]=o,l("sessionCount",o,366),v.info("Session count: "+o),!i){for(var s={},d=["UTM Source","UTM Medium","UTM Campaign","UTM Term","UTM Content","Landing page","Landing page type","Referrer","Referrer domain","Referrer type"],u=0;u<d.length;u++)s[d[u]]=null;var m=c();Object.keys(m).length>0&&(v.info("utm params:"),v.info(m),s=p(s,m));var S,y=document.referrer.match(/https?:\/\/([^\/]+)(\/.*)/),T=null;y&&(T=y[1],S=y[2]),T===location.host?-1!==v.trackReferrerLandingPages.indexOf(S)?(v.info("Detected known untracked landing page: "+document.referrer),v.trackLandingPage=!0,v.landingPageTraits={path:S,url:document.referrer,$current_url:document.referrer,"Tracked from URL":location.href,referrer:""},s["Landing page"]=S):document.referrer===location.href?(v.trackLandingPage=!0,s["Landing page"]=location.pathname):v.trackDebugWarn("Landing page with local referrer - tracking code not on all pages?"):(v.trackLandingPage=!0,s["Landing page"]=location.pathname,s.Referrer=document.referrer?document.referrer:null,s["Referrer domain"]=T),s["Landing page"]&&(s["Landing page type"]=v.page),s["Referrer domain"]==location.host&&(s["Referrer type"]=v.detectPage(S)),s.utm_source||((f(document.URL,"gclid")||f(document.URL,"gclsrc"))&&(s.utm_source="google",s.utm_medium||(s.utm_medium="cpc")),"t.yesware.com"==s["Referrer domain"]&&(s.utm_source="Yesware",s.utm_medium||(s.utm_medium="email")));var k={},w={};for(var I in s)k[I+" [first touch]"]=s[I],w[I+" [last touch]"]=s[I];v.info("Attribution params:"),v.info(s),1==o&&(v.info("..setting first touch params"),v.globalTraits=p(v.globalTraits,h(k))),v.info("..setting last touch params"),v.globalTraits=p(v.globalTraits,w)}}function a(e,t,n){"object"==typeof n?v.adaptor.page(e,t,v.getTraitsToSend(n)):"object"==typeof t?v.adaptor.page(e,v.getTraitsToSend(t)):t?v.adaptor.page(e,t,v.getTraitsToSend()):v.adaptor.page(e,v.getTraitsToSend())}function o(){u(d(["ready"]))}function s(){u(d()),u(v.queue)}function d(t){if(e.queue&&e.queue.length){if(!t||!t.length){var n=e.queue;return e.queue=[],n}for(var r=[],i=[],a=0;a<e.queue.length;a++)-1!==t.indexOf(e.queue[a][0])?r.push(e.queue[a]):i.push(e.queue[a]);return e.queue=i,r}}function u(e){for(;e&&e.length>0;){var t=e.shift(),n=t.shift();v[n]&&v[n].apply(v,t)}}function c(){for(var e="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),t="",n={},r=0;r<e.length;++r)t=f(document.URL,e[r]),t.length&&(n["UTM "+titleCase(e[r].slice(4))]=t);return n}function f(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n="[\\?&]"+t+"=([^&#]*)",r=new RegExp(n),i=r.exec(e);return null===i||i&&"string"!=typeof i[1]&&i[1].length?"":decodeURIComponent(i[1]).replace(/\+/g," ")}function l(e,t,n,r){var i="";if(0!=n){var a=new Date;a.setTime(a.getTime()+24*n*60*60*1e3),i="expires="+a.toUTCString()}void 0===r&&(r=v.cookieDomain),document.cookie="sh_"+e+"="+t+"; "+i+";path=/"+(r?";domain="+r:"")}function g(e){for(var t="sh_"+e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var i=n[r];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""}function p(e,t){var n={};for(var r in e)n[r]=e[r];for(var r in t)n[r]=t[r];return n}function h(e){var t=v.adaptor.userTraits(),n={};for(var r in e)r in t||(n[r]=e[r]);return n}function m(e){for(var t=S(e),n=0;n<t.length;++n){var r="__tld__",i="."+t[n];if(l(r,1,0,i),g(r))return l(r,"",-100,i),i}return""}function S(e){var t=e.split("."),n=t[t.length-1],r=[];if(4==t.length&&parseInt(n,10)==n)return r;if(1>=t.length)return r;for(var i=t.length-2;i>=0;--i)r.push(t.slice(i).join("."));return r}var y={trackPages:null,page:null,trackAllPages:!1,detectURLChange:!0,detectHashChange:!1,domainsIgnore:["localhost"],domainsIgnoreIPAddress:!0,domainsIgnoreSubdomains:["staging","test"],trackReferrerLandingPages:[],globalTraits:{},pageTraits:{},thisPageTraits:{},userId:void 0,userTraits:{},detectLogout:void 0,logToConsole:!1,sessionTimeout:30,overrideReferrer:void 0},v=this;if(this.sniffed=!1,this.queue=[],this.adaptor=t,"object"!=typeof t||!t.check())return void(window.console&&console.error&&console.error("[SiteHound] adaptor not valid"));for(var T in y)void 0!==e[T]&&(y[T]=e[T]),this[T]=y[T];this.thisPageTraits["SiteHound library version"]=this.VERSION=VERSION;var k,w;return this.sniff=this.done=function(){try{if(v.info("Sniffing.."),n(location.host))return v.info("Ignoring host: "+location.host),void(v.adaptor=new SiteHound_Adaptor_Disabled);if(g("dnt"))return v.info("do-not-track cookie present"),void(v.adaptor=new SiteHound_Adaptor_Disabled);if(o(),r(),"function"==typeof v.adaptor.afterSniff&&v.adaptor.afterSniff(),v.sniffed)return;v.sniffed=!0,s(),!v.detectURLChange&&!v.detectHashChange||k||(w=location.href,k=setInterval(function(){(v.detectHashChange?location.href!==w:location.href.replace(/#.*$/,"")!==w.replace(/#.*$/,""))&&(v.overrideReferrer=w||document.referrer,w=location.href,v.info("Detected URL change: "+w),v.page=void 0,v.sniff())},1e3))}catch(e){this.trackError(e)}},this.deferUntilSniff=function(e,t){return v.sniffed?!1:(v.queue.push([e,t]),!0)},this.identifyOnce=function(e){v.deferUntilSniff("identifyOnce",arguments)||v.adaptor.identify(v.ignoreExistingTraits(e))},this.detectPage=function(e){void 0===e&&(e=location.pathname);for(var t in v.trackPages){var n=v.trackPages[t];Array.isArray(n)||(n=[n]);for(var r=0;r<n.length;++r){var i=n[r];if("function"==typeof i.test){if(i.test(e))return v.info("Detected page: "+t),t}else if("."===i[0]){if(e===location.pathname&&document.body.className.match(new RegExp("(?:^|\\s)"+RegExp.escape(i.slice(1))+"(?!\\S)")))return v.info("Detected page: "+t),t}else if(i.replace(/\/$/,"")===e.replace(/\/$/,""))return v.info("Detected page: "+t),t}}},this.getTraitsToSend=function(e){return"object"==typeof e?p(v.thisPageTraits,e):v.thisPageTraits},this.info=function(e){v.logToConsole&&window.console&&console.log&&("object"==typeof e?console.log(e):console.log("[SiteHound] "+e))},this.doNotTrack=function(e){e="undefined"==typeof e?!0:!!e,e?l("dnt","1",1e3):l("dnt","",-100)},this.info("Ready (v"+VERSION+")"),this.cookieDomain=m(location.hostname),this.info("Cookie domain: "+this.cookieDomain),g("dnt")?(v.info("do-not-track cookie present"),void(v.adaptor=new SiteHound_Adaptor_Disabled)):(window.sitehound=this,void(e.isDone&&this.sniff()))}function titleCase(e){return"string"==typeof e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):e}function getAdaptor(adaptor){var adaptorClass,result;if("object"==typeof adaptor)result=adaptor;else{adaptorClass=titleCase(adaptor)||"Segment";try{var result=eval("new SiteHound_Adaptor_"+adaptorClass)}catch(error){return void(window.console&&console.error&&(console.error("[SiteHound] adaptor class SiteHound_Adaptor_"+adaptorClass+" could not be loaded"),console.error("[SiteHound] "+error.name+"; "+error.message)))}}return result.check()?result:void(window.console&&console.error&&console.error("[SiteHound] failed to attach to "+(adaptorClass?adaptorClass:"adaptor")))}function SiteHound_Adaptor_Disabled(){this.check=this.ready=this.identify=this.track=this.trackLink=this.trackForm=this.page=this.alias=this.userId=this.userTraits=function(){}}function SiteHound_Adaptor_Segment(){window.analytics=window.analytics||[];var e=this;return this.check=function(){return"undefined"!=typeof analytics.ready},this.check()?(this.calledPage=!1,analytics.on("page",function(){e.calledPage=!0}),this.ready=function(e){analytics.ready(e)},this.identify=function(e,t){analytics.identify(e,t)},this.track=function(e,t){analytics.track(e,t)},this.trackLink=function(e,t,n){analytics.trackLink(e,t,n)},this.trackForm=function(e,t,n){analytics.trackForm(e,t,n)},this.page=function(t,n,r){e.calledPage=!0,analytics.page(t,n,r)},this.alias=function(e){analytics.alias(e)},this.userId=function(){var e=analytics.user();return e?e.id():void 0},this.userTraits=function(){var e=analytics.user(),t=e.traits();return t},void(this.afterSniff=function(){e.calledPage||analytics.page()})):void(window.console&&console.error&&console.error("[SiteHound] window.analytics is not initialized - ensure analytics.js snippet is included first"))}var VERSION="0.89";!function(){var e=window.sitehound||{},t=getAdaptor(e.adaptor);t.ready(function(){var e=window.sitehound||{};new SiteHound(e,t)})}(),SiteHound.prototype.identify=function(e,t){this.deferUntilSniff("identify",arguments)||this.adaptor.identify(e,t)},SiteHound.prototype.track=function(e,t){this.deferUntilSniff("track",arguments)||("object"==typeof t?this.adaptor.track(e,this.getTraitsToSend(t)):this.adaptor.track(e,this.getTraitsToSend()))},SiteHound.prototype.trackOnce=function(e,t){if(!this.deferUntilSniff("trackOnce",arguments)){var n=this.adaptor.userTraits();if(void 0===n["First "+e]){var r={};r["First "+e]=(new Date).toISOString(),this.adaptor.identify(r),this.track(e,t)}}},SiteHound.prototype.trackAndCount=function(e,t){if(!this.deferUntilSniff("trackAndCount",arguments)){var n=this.adaptor.userTraits(),r=1;n&&(r=n[e+" Count"]?parseInt(n[e+" Count"])+1:1);var i={};i["First "+e]=(new Date).toISOString(),this.identifyOnce(i);var a={};a[e+" Count"]=r,a["Last "+e]=(new Date).toISOString(),this.adaptor.identify(a),this.track(e,t)}},SiteHound.prototype.trackLink=function(e,t){this.deferUntilSniff("trackLink",arguments)||this.adaptor.trackLink(e,t,this.getTraitsToSend())},SiteHound.prototype.trackForm=function(e,t){this.deferUntilSniff("trackForm",arguments)||this.adaptor.trackForm(e,t,this.getTraitsToSend())},SiteHound.prototype.ready=function(e){"function"==typeof e?(this.info("ready()"),e()):window.console&&console.error&&console.error("[SiteHound] ready() called with something that isn't a function")},SiteHound.prototype.load=function(e){this.info("load() called when already loaded"),e&&(this.info("updating adaptor to: "+e),this.adaptor=getAdaptor(e))},SiteHound.prototype.trackDebugInfo=function(e){this.trackDebug(e,"info")},SiteHound.prototype.trackDebugWarn=function(e){this.trackDebug(e,"warn")},SiteHound.prototype.trackDebug=function(e,t){t||(t="info"),this.adaptor.track("Tracking Debug",{message:e,level:t,"SiteHound library version":this.VERSION}),this.info("["+t+"] "+e)},SiteHound.prototype.trackError=function(e){this.adaptor.track("Tracking Error",{name:e.name,message:e.message,"SiteHound library version":this.VERSION}),window.console&&console.error&&console.error("[SiteHound] "+e.name+"; "+e.message)}}();