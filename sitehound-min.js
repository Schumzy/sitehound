//
//  SiteHound - Easy & powerful user, session and event tracking
//  ~~ 500 Startups Distro Team // #500STRONG // 500.co ~~
//
//  @author        Andy Young // @andyy // andy@apexa.co.uk
//  @version       0.8 - 3rd April 2016
//  @licence       GNU GPL v3
//
//  Copyright (C) 2016 Andy Young // andy@apexa.co.uk
//
//  This program is free software: you can redistribute it and/or modify
//  it under the terms of the GNU General Public License as published by
//  the Free Software Foundation, either version 3 of the License, or
//  (at your option) any later version.
//
//  This program is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//  GNU General Public License for more details.
//
//  You should have received a copy of the GNU General Public License
//  along with this program.  If not, see <http://www.gnu.org/licenses/>.
//
!function(){function SiteHound(e,t){function r(e){if(-1!=S.domainsIgnore.indexOf(e))return!0;if(S.domainsIgnoreIPAddress&&/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(e))return!0;for(var t=0;t<S.domainsIgnoreSubdomains.length;t++)if(0==e.indexOf(S.domainsIgnoreSubdomains[0]+"."))return!0;return!1}function i(){S.page||(S.page=n(location.pathname)),void 0!==S.overrideReferrer&&(S.thisPageTraits.referrer=S.thisPageTraits.Referrer=S.thisPageTraits.$referrer=S.overrideReferrer),a();var e=S.adaptor.userTraits();if(e.createdAt&&(S.globalTraits["Days since signup"]=Math.floor((new Date-new Date(e.createdAt))/1e3/60/60/24),S.info("Days since signup: "+S.globalTraits["Days since signup"])),S.userTraits["email domain"]?S.userTraits["email domain"]=S.userTraits["email domain"].match(/[^@]*$/)[0]:(e.email||S.userTraits.email)&&(S.userTraits["email domain"]=(e.email||S.userTraits.email).match(/[^@]*$/)[0]),window.FS&&window.FS.getCurrentSessionURL)S.globalTraits["Fullstory URL"]=FS.getCurrentSessionURL();else if(!S.sniffed){var t=window._fs_ready;window._fs_ready=function(){S.adaptor.identify({"Fullstory URL":FS.getCurrentSessionURL()}),"function"==typeof t&&t()}}if(S.userId){S.info("Received userId: "+S.userId);var e={};for(var r in S.userTraits)e["User "+r]=S.userTraits[r];var i,s=l(S.globalTraits,e);S.adaptor.userId()?(i=S.adaptor.userId(),S.info("Current userId: "+i)):(S.info("Anonymous session until now - alias()"),S.adaptor.alias(S.userId),S.adaptor.identify("x")),S.info("identify("+S.userId+", [traits])"),S.userId!==i&&(s=l(s,g({createdAt:(new Date).toISOString()}))),S.adaptor.identify(S.userId,s),S.userId!==i&&(S.info("userId != currentUserId - Login"),S.track("Login")),u("logged_out","",-100)}else S.adaptor.identify(S.globalTraits),S.detectLogout=void 0===S.detectLogout?void 0!==S.userId:S.detectLogout,S.detectLogout&&(S.info("Detecting potential logout.."),S.adaptor.userId()&&(f("logged_out")||(S.track("Logout"),u("logged_out",!0),S.info("Logout"))));if(S.trackLandingPage&&o("Landing",S.landingPageTraits),S.page){var d=S.page.split("|",2).map(function(e){return e.trim()});d.push(S.pageTraits);o.apply(S,d)}else S.trackAllPages&&o("Unidentified")}function n(e){for(var t in S.trackPages){var r=S.trackPages[t];Array.isArray(r)||(r=[r]);for(var i=0;i<r.length;++i){var n=r[i];if("function"==typeof n.test){if(n.test(e))return S.info("Detected page: "+t),t}else if("."===n[0]){if(e===location.pathname&&document.body.className.match(new RegExp("(?:^|\\s)"+RegExp.escape(n.slice(1))+"(?!\\S)")))return S.info("Detected page: "+t),t}else if(n.replace(/\/$/,"")===e.replace(/\/$/,""))return S.info("Detected page: "+t),t}}}function a(){var e=f("firstSeen")||(new Date).toISOString();u("firstSeen",e,366);var t=Math.floor((new Date-new Date(e))/1e3/60/60/24);S.globalTraits["First seen"]=e,S.globalTraits["Days since first seen"]=t,S.info("Visitor first seen: "+e),S.info("Days since first seen: "+t);var r=f("sessionStarted")||(new Date).toISOString(),i=(f("sessionUpdated")||(new Date).toISOString(),Math.floor((new Date-new Date(r))/1e3/60));S.globalTraits["Session started"]=r,S.globalTraits["Minutes since session start"]=i,S.info("Session started: "+r),S.info("Session duration: "+i);var a=i>S.sessionTimeout;a&&(S.info("Session timed out - tracking as new session"),r=(new Date).toISOString()),u("sessionStarted",r),u("sessionUpdated",(new Date).toISOString());var o=(a?0:parseInt(f("pageViews")||0))+1;if(S.thisPageTraits["Pageviews this session"]=o,u("pageViews",o),S.info("Pageviews: "+o),S.isLandingPage=!1,!a){if(o>1)return;S.isLandingPage=!0,S.info("Detected landing page")}var s=parseInt(f("sessionCount")||0)+1;if(S.globalTraits["Session count"]=s,u("sessionCount",s,366),S.info("Session count: "+s),!a){for(var p={},h=["UTM Source","UTM Medium","UTM Campaign","UTM Term","UTM Content","Landing page","Landing page type","Referrer","Referrer domain","Referrer type"],m=0;m<h.length;m++)p[h[m]]=null;var v=d();Object.keys(v).length>0&&(S.info("utm params:"),S.info(v),p=l(p,v));var y,T=document.referrer.match(/https?:\/\/([^\/]+)(\/.*)/),k=null;T&&(k=T[1],y=T[2]),k===location.host?-1!==S.trackReferrerLandingPages.indexOf(y)?(S.info("Detected known untracked landing page: "+document.referrer),S.trackLandingPage=!0,S.landingPageTraits={path:y,url:document.referrer,$current_url:document.referrer,"Tracked from URL":location.href,referrer:""},p["Landing page"]=y):document.referrer===location.href?(S.trackLandingPage=!0,p["Landing page"]=location.pathname):S.trackDebugWarn("Landing page with local referrer - tracking code not on all pages?"):(S.trackLandingPage=!0,p["Landing page"]=location.pathname,p.Referrer=document.referrer?document.referrer:null,p["Referrer domain"]=k),p["Landing page"]&&(p["Landing page type"]=S.page),p["Referrer domain"]==location.host&&(p["Referrer type"]=n(y)),p.utm_source||((c(document.URL,"gclid")||c(document.URL,"gclsrc"))&&(p.utm_source="google",p.utm_medium||(p.utm_medium="cpc")),"t.yesware.com"==p["Referrer domain"]&&(p.utm_source="Yesware",p.utm_medium||(p.utm_medium="email")));var w={},I={};for(var b in p)w[b+" [first touch]"]=p[b],I[b+" [last touch]"]=p[b];S.info("Attribution params:"),S.info(p),1==s&&(S.info("..setting first touch params"),S.globalTraits=l(S.globalTraits,g(w))),S.info("..setting last touch params"),S.globalTraits=l(S.globalTraits,I)}}function o(e,t,r){"object"==typeof r?S.adaptor.page(e,t,S.getTraitsToSend(r)):"object"==typeof t?S.adaptor.page(e,S.getTraitsToSend(t)):t?S.adaptor.page(e,t,S.getTraitsToSend()):S.adaptor.page(e,S.getTraitsToSend())}function s(){for(;e.queue&&e.queue.length>0;){var t=e.queue.shift(),r=t.shift();S[r]&&S[r].apply(S,t)}}function d(){for(var e="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),t="",r={},i=0;i<e.length;++i)t=c(document.URL,e[i]),t.length&&(r["UTM "+titleCase(e[i].slice(4))]=t);return r}function c(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r="[\\?&]"+t+"=([^&#]*)",i=new RegExp(r),n=i.exec(e);return null===n||n&&"string"!=typeof n[1]&&n[1].length?"":decodeURIComponent(n[1]).replace(/\+/g," ")}function u(e,t,r,i){var n="";if(0!=r){var a=new Date;a.setTime(a.getTime()+24*r*60*60*1e3),n="expires="+a.toUTCString()}void 0===i&&(i=S.cookieDomain),document.cookie="sh_"+e+"="+t+"; "+n+";path=/"+(i?";domain="+i:"")}function f(e){for(var t="sh_"+e+"=",r=document.cookie.split(";"),i=0;i<r.length;i++){for(var n=r[i];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""}function l(e,t){var r={};for(var i in e)r[i]=e[i];for(var i in t)r[i]=t[i];return r}function g(e){var t=S.adaptor.userTraits(),r={};for(var i in e)i in t||(r[i]=e[i]);return r}function p(e){for(var t=h(e),r=0;r<t.length;++r){var i="__tld__",n="."+t[r];if(u(i,1,0,n),f(i))return u(i,"",-100,n),n}return""}function h(e){var t=e.split("."),r=t[t.length-1],i=[];if(4==t.length&&parseInt(r,10)==r)return i;if(1>=t.length)return i;for(var n=t.length-2;n>=0;--n)i.push(t.slice(n).join("."));return i}var m={trackPages:null,page:null,trackAllPages:!1,detectURLChange:!0,detectHashChange:!1,domainsIgnore:["localhost"],domainsIgnoreIPAddress:!0,domainsIgnoreSubdomains:["staging","test"],trackReferrerLandingPages:[],globalTraits:{},pageTraits:{},thisPageTraits:{},userId:void 0,userTraits:{},detectLogout:void 0,logToConsole:!1,sessionTimeout:30,overrideReferrer:void 0},S=this;if(this.adaptor=t,"object"!=typeof t||!t.check())return void(window.console&&console.error&&console.error("[SiteHound] adaptor not valid"));for(var v in m)void 0!==e[v]&&(m[v]=e[v]),this[v]=m[v];this.thisPageTraits["SiteHound library version"]=this.VERSION=VERSION;var y,T;return this.sniff=this.done=function(){try{if(S.info("Sniffing.."),r(location.host))return S.info("Ignoring host: "+location.host),void(S.adaptor=new SiteHound_Adaptor_Disabled);if(f("dnt"))return S.info("do-not-track cookie present"),void(S.adaptor=new SiteHound_Adaptor_Disabled);if(i(),"function"==typeof S.adaptor.afterSniff&&S.adaptor.afterSniff(),s(),S.sniffed)return;S.sniffed=!0,!S.detectURLChange&&!S.detectHashChange||y||(T=location.href,y=setInterval(function(){(S.detectHashChange?location.href!==T:location.href.replace(/#.*$/,"")!==T.replace(/#.*$/,""))&&(S.overrideReferrer=T||document.referrer,T=location.href,S.info("Detected URL change: "+T),S.page=void 0,S.sniff())},1e3))}catch(e){this.trackError(e)}},this.identifyOnce=function(e){S.adaptor.identify(S.ignoreExistingTraits(e))},this.getTraitsToSend=function(e){return"object"==typeof e?l(S.thisPageTraits,e):S.thisPageTraits},this.info=function(e){S.logToConsole&&window.console&&console.log&&("object"==typeof e?console.log(e):console.log("[SiteHound] "+e))},this.doNotTrack=function(e){e="undefined"==typeof e?!0:!!e,e?u("dnt","1",1e3):u("dnt","",-100)},this.info("Ready (v"+VERSION+")"),this.cookieDomain=p(location.hostname),this.info("Cookie domain: "+this.cookieDomain),f("dnt")?(S.info("do-not-track cookie present"),void(S.adaptor=new SiteHound_Adaptor_Disabled)):void(e.isDone&&this.sniff())}function SiteHound_Adaptor_Disabled(){this.check=this.ready=this.identify=this.track=this.trackLink=this.trackForm=this.page=this.alias=this.userId=this.userTraits=function(){}}function SiteHound_Adaptor_Segment(){window.analytics=window.analytics||[];var e=this;return this.check=function(){return"undefined"!=typeof analytics.ready},this.check()?(this.calledPage=!1,analytics.on("page",function(){e.calledPage=!0}),this.ready=function(e){analytics.ready(e)},this.identify=function(e,t){analytics.identify(e,t)},this.track=function(e,t){analytics.track(e,t)},this.trackLink=function(e,t,r){analytics.trackLink(e,t,r)},this.trackForm=function(e,t,r){analytics.trackForm(e,t,r)},this.page=function(t,r,i){e.calledPage=!0,analytics.page(t,r,i)},this.alias=function(e){analytics.alias(e)},this.userId=function(){var e=analytics.user();return e?e.id():void 0},this.userTraits=function(){var e=analytics.user(),t=e.traits();return t},void(this.afterSniff=function(){e.calledPage||analytics.page()})):void(window.console&&console.error&&console.error("[SiteHound] window.analytics is not initialized - ensure analytics.js snippet is included first"))}function titleCase(e){return"string"==typeof e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):e}var VERSION="0.8";!function(){var initialConfig=window.sitehound||{},adaptorClass;if("object"!=typeof initialConfig.adaptor){adaptorClass=titleCase(initialConfig.adaptor)||"Segment";try{var adaptor=eval("new SiteHound_Adaptor_"+adaptorClass)}catch(error){return void(window.console&&console.error&&(console.error("[SiteHound] adaptor class SiteHound_Adaptor_"+adaptorClass+" could not be loaded"),console.error("[SiteHound] "+error.name+"; "+error.message)))}}else var adaptor=initialConfig.adaptor;return adaptor.check()?void adaptor.ready(function(){var e=window.sitehound||{},t=new SiteHound(e,adaptor);window.sitehound=t}):void(window.console&&console.error&&console.error("[SiteHound] failed to attach to "+(adaptorClass?adaptorClass:"adaptor")))}(),SiteHound.prototype.identify=function(e,t){this.adaptor.identify(e,t)},SiteHound.prototype.track=function(e,t){"object"==typeof t?this.adaptor.track(e,this.getTraitsToSend(t)):this.adaptor.track(e,this.getTraitsToSend())},SiteHound.prototype.trackOnce=function(e,t){var r=this.adaptor.userTraits();if(void 0===r["First "+e]){var i={};i["First "+e]=(new Date).toISOString(),this.adaptor.identify(i),this.track(e,t)}},SiteHound.prototype.trackAndCount=function(e,t){var r=this.adaptor.userTraits(),i=1;r&&(i=r[e+" Count"]?parseInt(r[e+" Count"])+1:1);var n={};n["First "+e]=(new Date).toISOString(),this.identifyOnce(n);var a={};a[e+" Count"]=i,a["Last "+e]=(new Date).toISOString(),this.adaptor.identify(a),this.track(e,t)},SiteHound.prototype.trackLink=function(e,t){this.adaptor.trackLink(e,t,this.getTraitsToSend())},SiteHound.prototype.trackForm=function(e,t){this.adaptor.trackForm(e,t,this.getTraitsToSend())},SiteHound.prototype.trackDebugInfo=function(e){this.trackDebug(e,"info")},SiteHound.prototype.trackDebugWarn=function(e){this.trackDebug(e,"warn")},SiteHound.prototype.trackDebug=function(e,t){this.adaptor.track("Tracking Debug",{message:e,level:t,"SiteHound library version":this.VERSION}),this.info("["+t+"] "+e)},SiteHound.prototype.trackError=function(e){this.adaptor.track("Tracking Error",{name:e.name,message:e.message,"SiteHound library version":this.VERSION}),window.console&&console.error&&console.error("[SiteHound] "+e.name+"; "+e.message)}}();