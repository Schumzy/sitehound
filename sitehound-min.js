//
//  SiteHound - Easy & powerful website analytics tracking
//
//  Docs: http://www.sitehound.co
//  Source: https://github.com/andyyoung/sitehound
//
//  @author        Andy Young // @andyy // andy@apexa.co.uk
//  @version       0.9.66 - 6th June 2016
//  @licence       GNU GPL v3  http://www.gnu.org/licenses/
//
//  Copyright (C) 2016 Andy Young // andy@apexa.co.uk
//  ~~ 500 Startups Distro Team // #500STRONG // 500.co ~~
//
!function(){function e(){var e=window.sitehound=window.sitehound||[],i=o(e.adaptor);i&&(e.silent||s("Waiting for "+i.klass+" to load.."),i.ready(function(){var e=window.sitehound||[];new t(e,i)}))}function t(e,t){function a(){return C.info("Loaded (version "+c+", adaptor: "+C.adaptor.klass+")"),C.cookieDomain=D(location.hostname),C.debug("Cookie domain: "+C.cookieDomain),g("dnt")?(C.info("Do-not-track cookie present - disabling."),void(C.adaptor="disabled")):(g("logToConsole")&&(C.logToConsole=!0),window.sitehound=C,window.mixpanel&&window.mixpanel.persistence&&document.cookie.indexOf(window.mixpanel.persistence.name+"=")>-1&&d("Warning: Mixpanel cookie detected - update Mixpanel config to use localStorage."),m(),void((e.sniffOnLoad||e.isDone)&&C.sniff()))}function o(e){if(-1!=C.domainsIgnore.indexOf(e))return!0;if(C.domainsIgnoreIPAddress&&/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(e))return!0;for(var t=0;t<C.domainsIgnoreSubdomains.length;t++)if(0==e.indexOf(C.domainsIgnoreSubdomains[t]+"."))return!0;return!1}function u(){C.sniffed=!0,C.page||(C.page=C.detectPage()),C.thisPageTraits["Page Type"]=C.page,l();var e=C.adaptor.userTraits();if(e.createdAt&&(C.globalTraits["Days Since Signup"]=Math.floor((new Date-new Date(e.createdAt))/1e3/60/60/24),C.debug("Days since signup: "+C.globalTraits["Days Since Signup"])),C.userTraits["Email Domain"]?C.userTraits["Email Domain"]=C.userTraits["Email Domain"].match(/[^@]*$/)[0]:(e.Email||e.email||C.userTraits.Email)&&(C.userTraits["Email Domain"]=(e.Email||e.email||C.userTraits.Email).match(/[^@]*$/)[0]),window.FS&&window.FS.getCurrentSessionURL)C.globalTraits["Fullstory URL"]=FS.getCurrentSessionURL();else if(!C.sniffed){var t=window._fs_ready;window._fs_ready=function(){C.adaptor.identify({"Fullstory URL":FS.getCurrentSessionURL()}),"function"==typeof t&&t()}}var i=f(e);if(void 0!==C.overrideReferrer&&(C.thisPageTraits.referrer=C.thisPageTraits.Referrer=C.thisPageTraits.$referrer=C.overrideReferrer),p(),C.trackLandingPage&&(h("Landing",C.landingPageTraits),C.trackLandingPage=!1),C.page){var n=C.page.split("|",2).map(function(e){return e.trim()});n.push(C.pageTraits);h.apply(C,n)}else C.trackAllPages&&h("Unidentified");for(var r=0;r<i.length;r++)C.track(i[r][0],i[r][1])}function l(){var e=g("firstSeen")||(new Date).toISOString();k("firstSeen",e,366);var t=Math.floor((new Date-new Date(e))/1e3/60/60/24);C.globalTraits["First Seen"]=e,C.globalTraits["Days Since First Seen"]=t,C.debug("Visitor first seen: "+e),C.debug("Days since first seen: "+t);var i=g("sessionStarted")||(new Date).toISOString(),r=g("sessionUpdated")||(new Date).toISOString(),a=Math.floor((new Date-new Date(r))/1e3/60);C.debug("Session started: "+i),C.debug("Minutes since last event: "+a);var o=a>C.sessionTimeout;o&&(C.debug("Session timed out - tracking as new session"),i=(new Date).toISOString());var s=Math.floor((new Date-new Date(i))/1e3/60);C.debug("Session duration: "+s),C.globalTraits["Session Started"]=i,C.globalTraits["Minutes Since Session Start"]=s,k("sessionStarted",i),k("sessionUpdated",(new Date).toISOString());var d=(o?0:parseInt(g("pageViews")||0))+1;C.thisPageTraits["Pageviews This Session"]=d,k("pageViews",d),C.debug("Pageviews: "+d);var u,c=document.referrer.match(/https?:\/\/([^\/]+)(\/.*)/),l=null;if(c&&(l=c[1],u=c[2]),l==location.host&&(C.thisPageTraits["Referrer Type"]=C.detectPage(u)),C.isLandingPage=!1,!o){if(d>1)return;C.isLandingPage=!0,C.debug("Detected landing page")}var f=parseInt(g("sessionCount")||0)+1;if(C.globalTraits["Session Count"]=f,k("sessionCount",f,366),C.debug("Session count: "+f),!o){for(var p={},h=["UTM Source","UTM Medium","UTM Campaign","UTM Term","UTM Content","Landing Page","Landing Page Type","Initial Referrer","Initial Referring Domain"],m=0;m<h.length;m++)p[h[m]]=null;var v=w();Object.keys(v).length>0&&(C.debug("utm params:"),C.debug(v),p=n(p,v)),l===location.host?-1!==C.trackReferrerLandingPages.indexOf(u)?(C.debug("Detected known untracked landing page: "+document.referrer),C.trackLandingPage=!0,C.landingPageTraits={path:u,url:document.referrer,$current_url:document.referrer,"Tracked From URL":location.href,referrer:""},p["Landing Page"]=u):document.referrer===location.href?(C.trackLandingPage=!0,p["Landing Page"]=location.pathname):f>1||C.trackDebugWarn("Landing page with local referrer - tracking code not on all pages?"):(C.trackLandingPage=!0,p["Landing Page"]=location.pathname,p["Initial Referrer"]=document.referrer?document.referrer:null,p["Initial Referring Domain"]=l),p["Landing Page"]&&(p["Landing Page Type"]=C.page),p["UTM Source"]||((I(document.URL,"gclid")||I(document.URL,"gclsrc"))&&(p["UTM Source"]="google",p["UTM Medium"]||(p["UTM Medium"]="cpc")),"t.yesware.com"==p["Referring Domain"]&&(p["UTM Source"]="Yesware",p["UTM Medium"]||(p["UTM Medium"]="email")));var T={},b={};for(var y in p)T[y+" [first touch]"]=p[y],b[y+" [last touch]"]=p[y];C.debug("Attribution params:"),C.debug(p),1==f&&(C.debug("..setting first touch params"),C.globalTraits=n(C.globalTraits,L(T))),C.debug("..setting last touch params"),C.globalTraits=n(C.globalTraits,b)}}function f(e){var t=[],i=window.optimizely;if(!i||!i.data)return t;var n=i.data,r=n.state,a=n.sections,o=r.activeExperiments;if(r.redirectExperiment){var s=r.redirectExperiment.experimentId,d=r.activeExperiments.indexOf(s);-1===d&&(o.push(s),C.overrideReferrer=r.redirectExperiment.referrer)}if(!o.length)return t;var u="Optimizely Experiments",g="Optimizely Variations",c=e[u],l=e[g];C.globalTraits[u]=c?"function"==typeof c.indexOf?c:[c]:[],C.globalTraits[g]=l?"function"==typeof l.indexOf?l:[l]:[];for(var f=0;f<o.length;f++){var p=o[f],h=r.variationIdsMap[p][0].toString(),m={"Experiment ID":p,"Experiment Name":n.experiments[p].name,"Experiment First View":!c||!c.indexOf||-1===c.indexOf(p),"Variation ID":h,"Variation Name":r.variationNamesMap[p]};-1===C.globalTraits[u].indexOf(p)&&C.globalTraits[u].push(p);var v=a[p];if(v){m["Section Name"]=v.name,m["Variation ID"]=v.variation_ids.join();for(var T=0;T<v.variation_ids.length;T++)-1===C.globalTraits[g].indexOf(v.variation_ids[T])&&C.globalTraits[g].push(v.variation_ids[T])}else-1===C.globalTraits[g].indexOf(h)&&C.globalTraits[g].push(h);t.push(["Optimizely Experiment Viewed",m])}return C.globalTraits[u].sort(),C.globalTraits[g].sort(),t}function p(){if(C.userId){C.debug("doIdentify(): received userId: "+C.userId);var e={},t=["name","email","createdAt"];for(var r in C.userTraits){for(var a=r.toLowerCase(),o="",s=0;s<t.length;s++)if(a===t[s].toLowerCase()){o=t[s];break}o||(o="User "+i(r)),e[o]=C.userTraits[r]}var d,u=n(C.globalTraits,e);C.adaptor.userId()?(d=C.adaptor.userId(),C.debug("Current userId: "+d)):(C.debug("Anonymous session until now - alias()"),C.adaptor.alias(C.userId),C.adaptor.identify("x")),C.debug("adaptor.identify("+C.userId+", [traits])"),C.userId!==d&&(u=n(u,L({createdAt:(new Date).toISOString()}))),C.adaptor.identify(C.userId,u),C.userId!==d&&(C.debug("userId != currentUserId - Login"),C.track("Login")),k("logged_out","",-100)}else C.adaptor.identify(C.globalTraits),C.detectLogout=void 0===C.detectLogout?void 0!==C.userId:C.detectLogout,C.detectLogout&&!g("logged_out")&&(C.debug("doIdentify(): detecting potential logout.."),C.adaptor.userId()&&(C.track("Logout"),k("logged_out",!0),C.debug("Logout")))}function h(e,t,i){C.debug("Viewed Page: ",[e,t,i]),"object"==typeof i?C.adaptor.page(e,t,C.getTraitsToSend(i)):"object"==typeof t?C.adaptor.page(e,C.getTraitsToSend(t)):t?C.adaptor.page(e,t,C.getTraitsToSend()):C.adaptor.page(e,C.getTraitsToSend())}function m(){y(T(["ready"]))}function v(){y(T())}function T(e){if(C.queue&&C.queue.length){if(!e||!e.length){var t=C.queue;return C.queue=[],t}for(var i=[],n=[],r=0;r<C.queue.length;r++)-1!==e.indexOf(C.queue[r][0])?i.push(C.queue[r]):n.push(C.queue[r]);return C.queue=n,i}}function y(e){for(;e&&e.length>0;){var t=e.shift(),i=t.shift();C[i]&&C[i].apply(C,t)}}function S(e){C.debug("Detected URL change: "+location.href),C.overrideReferrer=e||document.referrer,C.page=void 0;for(var t=C.detectPage(),i=0;i<R.length;i++)R[i](t);C.sniff()}function k(e,t,i,n){var r="";if(0!=i){var a=new Date;a.setTime(a.getTime()+24*i*60*60*1e3),r="expires="+a.toUTCString()}void 0===n&&(n=C.cookieDomain),document.cookie="sh_"+e+"="+t+"; "+r+";path=/"+(n?";domain="+n:"")}function w(){for(var e="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),t="",n={},r=0;r<e.length;++r)t=I(document.URL,e[r]),t.length&&(n["UTM "+i(e[r].slice(4))]=t);return n}function I(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i="[\\?&]"+t+"=([^&#]*)",n=new RegExp(i),r=n.exec(e);return null===r||r&&"string"!=typeof r[1]&&r[1].length?"":decodeURIComponent(r[1]).replace(/\+/g," ")}function L(e){var t=C.adaptor.userTraits(),i={};if("undefined"==typeof t)return e;for(var n in e)n in t||(i[n]=e[n]);return i}function D(e){for(var t=U(e),i=0;i<t.length;++i){var n="__tld__",r="."+t[i];if(k(n,1,0,r),g(n))return k(n,"",-100,r),r}return""}function U(e){var t=e.split("."),i=t[t.length-1],n=[];if(4==t.length&&parseInt(i,10)==i)return n;if(1>=t.length)return n;for(var r=t.length-2;r>=0;--r)n.push(t.slice(r).join("."));return n}var O,P,C=this,R=[];return this.adaptor=t,"object"!=typeof t?void d("adaptor not valid"):(!function(){var t={trackPages:null,page:null,trackAllPages:!1,detectURLChange:!0,detectHashChange:!1,domainsIgnore:["localhost","gtm-msr.appspot.com"],domainsIgnoreIPAddress:!0,domainsIgnoreSubdomains:["staging","test"],trackReferrerLandingPages:[],globalTraits:{},pageTraits:{},thisPageTraits:{},userId:void 0,userTraits:{},detectLogout:void 0,logToConsole:!1,silent:!1,sessionTimeout:30,overrideReferrer:void 0,queue:[],SNIPPET_VERSION:void 0};C.sniffed=!1;for(var i in t)void 0!==e[i]&&(t[i]=e[i]),C[i]=t[i];if(e.length&&e.pop)for(var n=0;n<b.length;n++)C.queue.unshift(e.pop());C.thisPageTraits["SiteHound library version"]=C.VERSION=c}(),this.sniff=this.done=function(){try{if(C.info("sniff()"),o(location.hostname))return C.info("Ignoring host: "+location.hostname),void(C.adaptor="disabled");if(g("dnt"))return C.info("Do-not-track cookie present - disabling."),void(C.adaptor="disabled");var e=!C.sniffed;if(u(),!e)return;v(),!C.detectURLChange&&!C.detectHashChange||O||(P=location.href,O=setInterval(function(){(C.detectHashChange?location.href!==P:location.href.replace(/#.*$/,"")!==P.replace(/#.*$/,""))&&(S(P),P=location.href)},1e3))}catch(t){this.trackError(t)}},this.deferUntilSniff=function(e,t){return C.sniffed?!1:(t=Array.prototype.slice.call(t),t.unshift(e),C.queue.push(t),C.debug("(Deferring "+e+"() until sniff)"),!0)},this.identify=function(e,t){C.debug("identify",[e,t]),"object"==typeof t?(C.userId=e,C.globalTraits=n(C.globalTraits,t)):"object"==typeof e?C.globalTraits=n(C.globalTraits,e):C.userId=e,C.sniffed&&p()},this.identifyOnce=function(e){C.deferUntilSniff("identifyOnce",arguments)||(C.debug("identifyOnce",e),C.adaptor.identify(L(e)))},this.detectPage=function(e){void 0===e&&(e=location.pathname);for(var t in C.trackPages){var i=C.trackPages[t];Array.isArray(i)||(i=[i]);for(var n=0;n<i.length;++n){var a=i[n];if("function"==typeof a.test){if(a.test(e))return C.debug("Detected page: "+t),t}else if("."===a[0]){if(e===location.pathname&&document.body.className.match(new RegExp("(?:^|\\s)"+r(a.slice(1))+"(?!\\S)")))return C.debug("Detected page: "+t),t}else if(e.replace(/\/$/,"").match(new RegExp("^"+r(a.replace(/\/$/,"")).replace(/\\\*/g,".*")+"$")))return C.debug("Detected page: "+t),t}}},this.getTraitsToSend=function(e){var t=n(C.globalTraits,C.thisPageTraits);return"object"==typeof e?n(t,e):t},this.info=function(e,t){C.silent||s(e,t)},this.debug=function(e,t){C.logToConsole&&s(e,t)},this.doNotTrack=function(e){e="undefined"==typeof e?!0:!!e,e?k("dnt","1",1e3):k("dnt","",-100),C.debug("doNotTrack",e?"true":"false")},this.debugMode=function(e){C.logToConsole=e="undefined"==typeof e?!0:!!e,e?k("logToConsole","1",1e3):k("logToConsole","",-100),C.debug("debugMode",e?"true":"false")},this.onURLChange=this.onUrlChange=function(e){"function"==typeof e?(this.debug("onURLChange()"),R.push(e)):d("onURLChange() called with something that isn't a function")},void a())}function i(e){return"string"==typeof e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):e}function n(e,t){var i={};for(var n in e)i[n]=e[n];for(var n in t)i[n]=t[n];return i}function r(e){return e.replace(/([\/*.?[\]()\-\|])/g,"\\$1")}function a(e,t){f[e]=t,t.prototype.klass=e}function o(e){var t,i;if("object"==typeof e)i=e;else{t=(e||"segment").toLowerCase()||"segment";try{var i=new f[t]}catch(n){return n("adaptor "+t+" could not be loaded"),void n(n.name+"; "+n.message)}}return i}function s(e,t){if(window.console&&console.log)try{"object"==typeof e?JSON&&JSON.stringify&&(e=l+JSON.stringify(e)):e=l+e,t&&JSON&&JSON.stringify&&(e=e+"("+JSON.stringify(t).slice(1).slice(0,-1)+")",t=null),console.log(e),t&&console.log(t)}catch(i){i(i.name+"; "+i.message)}}function d(e){window.console&&(console.error?console.error(l+e):console.log&&console.log(l+"[ERROR] "+e))}function u(e,t,i){for(var n=i||window,r=e.split("."),a=0;a<r.length;a++){if("undefined"==typeof n[r[a]])return void setTimeout(function(){u(e,t,i)},50);n=n[r[a]]}t()}function g(e,t){void 0===t&&(t="sh_");for(var i=t+e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var a=n[r];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(i))return a.substring(i.length,a.length)}return""}var c="0.9.66",l="[SiteHound] ",f={};t.prototype.push=function(e){var t=e.shift();self[t]?self[t].apply(self,e):this.debug("Unrecognised method: "+t)},t.prototype.alias=function(e){this.deferUntilSniff("alias",arguments)||(this.debug("alias",[e]),this.adaptor.alias(e))},t.prototype.track=function(e,t){this.deferUntilSniff("track",arguments)||(t="object"==typeof t?this.getTraitsToSend(t):this.getTraitsToSend(),this.debug("track",[e,t]),this.adaptor.track(e,t))},t.prototype.trackOnce=function(e,t){if(!this.deferUntilSniff("trackOnce",arguments)){this.debug("trackOnce",[e,t]);var i=this.adaptor.userTraits();if(void 0===i["First "+e]){var n={};n["First "+e]=(new Date).toISOString(),this.adaptor.identify(n),this.track(e,t)}}},t.prototype.trackAndCount=function(e,t){if(!this.deferUntilSniff("trackAndCount",arguments)){this.debug("trackAndCount",[e,t]);var i=this.adaptor.userTraits(),n=1;i&&(n=i[e+" Count"]?parseInt(i[e+" Count"])+1:1);var r={};r["First "+e]=(new Date).toISOString(),this.identifyOnce(r);var a={};a[e+" Count"]=n,a["Last "+e]=(new Date).toISOString(),this.adaptor.identify(a),this.track(e,t)}},t.prototype.trackLink=function(e,t){if(!this.deferUntilSniff("trackLink",arguments)){var i={};e&&e.selector&&(i.selector=e.selector),e&&e.length&&(i.length=e.length),this.debug("trackLink",[i,t]),this.adaptor.trackLink(e,t,this.getTraitsToSend())}},t.prototype.trackForm=function(e,t){if(!this.deferUntilSniff("trackForm",arguments)){var i={};e&&e.selector&&(i.selector=e.selector),e&&e.length&&(i.length=e.length),this.debug("trackForm",[i,t]),this.adaptor.trackForm(e,t,this.getTraitsToSend())}},t.prototype.ready=function(e){if("function"==typeof e){var t=this.detectPage();this.debug("ready("+t+")"),e(t)}else d("ready() called with something that isn't a function")},t.prototype.getUserTraits=function(){return result=n(this.adaptor.userTraits(),this.userTraits),this.debug("getUserTraits() returned ",result),result},t.prototype.load=function(e){this.debug("load() called when already loaded"),e&&(this.adaptor=o(e),this.info("Updated adaptor to: "+e.klass))},t.prototype.trackDebugInfo=function(e){this.trackDebug(e,"info")},t.prototype.trackDebugWarn=function(e){this.trackDebug(e,"warn")},t.prototype.trackDebug=function(e,t){t||(t="info"),this.adaptor.track("Tracking Debug",{message:e,level:t,"SiteHound library version":this.VERSION}),this.debug("["+t+"] "+e)},t.prototype.trackError=function(e){this.adaptor.track("Tracking Error",{name:e.name,message:e.message,"SiteHound library version":this.VERSION}),e(e.name+"; "+e.message)},a("disabled",function(){this.ready=this.identify=this.track=this.trackLink=this.trackForm=this.page=this.alias=this.userId=this.userTraits=function(){}}),a("segment",function(){this.ready=function(e){u("analytics.ready",function(){(window.sitehound&&window.sitehound.logToConsole||g("logToConsole"))&&s("window.analytics detected"),analytics.ready(e)})},this.identify=function(e,t){analytics.identify(e,t)},this.track=function(e,t){analytics.track(e,t)},this.trackLink=function(e,t,i){analytics.trackLink(e,t,i)},this.trackForm=function(e,t,i){analytics.trackForm(e,t,i)},this.page=function(e,t,i){analytics.page(e,t,i)},this.alias=function(e){analytics.alias(e)},this.userId=function(){var e=analytics.user();return e?e.id():void 0},this.userTraits=function(){var e=analytics.user(),t=e.traits();return t}}),e()}();