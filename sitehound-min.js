//
//  SiteHound - Easy & powerful website analytics tracking
//
//  Docs: http://www.sitehound.co
//  Source: https://github.com/andyyoung/sitehound
//
//  @author        Andy Young // @andyy // andy@apexa.co.uk
//  @version       0.9.66 - 6th June 2016
//  @licence       GNU GPL v3  http://www.gnu.org/licenses/
//
//  Copyright (C) 2016 Andy Young // andy@apexa.co.uk
//  ~~ 500 Startups Distro Team // #500STRONG // 500.co ~~
//
!function(){function e(){var e=window.sitehound=window.sitehound||[],i=o(e.adaptor);i&&(e.silent||s("Waiting for "+i.klass+" to load.."),i.ready(function(){var e=window.sitehound||[];new t(e,i)}))}function t(e,t){function a(){return R.info("Loaded (version "+g+", adaptor: "+R.adaptor.klass+")"),R.cookieDomain=D(location.hostname),R.debug("Cookie domain: "+R.cookieDomain),k("dnt")?(R.info("Do-not-track cookie present - disabling."),void(R.adaptor="disabled")):(k("logToConsole")&&(R.logToConsole=!0),window.sitehound=R,window.mixpanel&&window.mixpanel.persistence&&document.cookie.indexOf(window.mixpanel.persistence.name+"=")>-1&&d("Warning: Mixpanel cookie detected - update Mixpanel config to use localStorage."),h(),void((e.sniffOnLoad||e.isDone)&&R.sniff()))}function o(e){if(-1!=R.domainsIgnore.indexOf(e))return!0;if(R.domainsIgnoreIPAddress&&/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(e))return!0;for(var t=0;t<R.domainsIgnoreSubdomains.length;t++)if(0==e.indexOf(R.domainsIgnoreSubdomains[t]+"."))return!0;return!1}function u(){R.sniffed=!0,R.page||(R.page=R.detectPage()),R.thisPageTraits["Page Type"]=R.page,c();var e=R.adaptor.userTraits();if(e.createdAt&&(R.globalTraits["Days Since Signup"]=Math.floor((new Date-new Date(e.createdAt))/1e3/60/60/24),R.debug("Days since signup: "+R.globalTraits["Days Since Signup"])),R.userTraits["Email Domain"]?R.userTraits["Email Domain"]=R.userTraits["Email Domain"].match(/[^@]*$/)[0]:(e.Email||e.email||R.userTraits.Email)&&(R.userTraits["Email Domain"]=(e.Email||e.email||R.userTraits.Email).match(/[^@]*$/)[0]),window.FS&&window.FS.getCurrentSessionURL)R.globalTraits["Fullstory URL"]=FS.getCurrentSessionURL();else if(!R.sniffed){var t=window._fs_ready;window._fs_ready=function(){R.adaptor.identify({"Fullstory URL":FS.getCurrentSessionURL()}),"function"==typeof t&&t()}}var i=f(e);if(void 0!==R.overrideReferrer&&(R.thisPageTraits.referrer=R.thisPageTraits.Referrer=R.thisPageTraits.$referrer=R.overrideReferrer),l(),R.trackLandingPage&&(p("Landing",R.landingPageTraits),R.trackLandingPage=!1),R.page){var n=R.page.split("|",2).map(function(e){return e.trim()});n.push(R.pageTraits);p.apply(R,n)}else R.trackAllPages&&p("Unidentified");for(var r=0;r<i.length;r++)R.track(i[r][0],i[r][1])}function c(){var e=k("firstSeen")||(new Date).toISOString();S("firstSeen",e,366);var t=Math.floor((new Date-new Date(e))/1e3/60/60/24);R.globalTraits["First Seen"]=e,R.globalTraits["Days Since First Seen"]=t,R.debug("Visitor first seen: "+e),R.debug("Days since first seen: "+t);var i=k("sessionStarted")||(new Date).toISOString(),r=k("sessionUpdated")||(new Date).toISOString(),a=Math.floor((new Date-new Date(r))/1e3/60);R.debug("Session started: "+i),R.debug("Minutes since last event: "+a);var o=a>R.sessionTimeout;o&&(R.debug("Session timed out - tracking as new session"),i=(new Date).toISOString());var s=Math.floor((new Date-new Date(i))/1e3/60);R.debug("Session duration: "+s),R.globalTraits["Session Started"]=i,R.globalTraits["Minutes Since Session Start"]=s,S("sessionStarted",i),S("sessionUpdated",(new Date).toISOString());var d=(o?0:parseInt(k("pageViews")||0))+1;R.thisPageTraits["Pageviews This Session"]=d,S("pageViews",d),R.debug("Pageviews: "+d);var u,g=document.referrer.match(/https?:\/\/([^\/]+)(\/.*)/),c=null;if(g&&(c=g[1],u=g[2]),c==location.host&&(R.thisPageTraits["Referrer Type"]=R.detectPage(u)),R.isLandingPage=!1,!o){if(d>1)return;R.isLandingPage=!0,R.debug("Detected landing page")}var f=parseInt(k("sessionCount")||0)+1;if(R.globalTraits["Session Count"]=f,S("sessionCount",f,366),R.debug("Session count: "+f),!o){for(var l={},p=["UTM Source","UTM Medium","UTM Campaign","UTM Term","UTM Content","Landing Page","Landing Page Type","Initial Referrer","Initial Referring Domain"],h=0;h<p.length;h++)l[p[h]]=null;var m=w();Object.keys(m).length>0&&(R.debug("utm params:"),R.debug(m),l=n(l,m)),c===location.host?-1!==R.trackReferrerLandingPages.indexOf(u)?(R.debug("Detected known untracked landing page: "+document.referrer),R.trackLandingPage=!0,R.landingPageTraits={path:u,url:document.referrer,$current_url:document.referrer,"Tracked From URL":location.href,referrer:""},l["Landing Page"]=u):document.referrer===location.href?(R.trackLandingPage=!0,l["Landing Page"]=location.pathname):f>1||R.trackDebugWarn("Landing page with local referrer - tracking code not on all pages?"):(R.trackLandingPage=!0,l["Landing Page"]=location.pathname,l["Initial Referrer"]=document.referrer?document.referrer:null,l["Initial Referring Domain"]=c),l["Landing Page"]&&(l["Landing Page Type"]=R.page),l["UTM Source"]||((I(document.URL,"gclid")||I(document.URL,"gclsrc"))&&(l["UTM Source"]="google",l["UTM Medium"]||(l["UTM Medium"]="cpc")),"t.yesware.com"==l["Referring Domain"]&&(l["UTM Source"]="Yesware",l["UTM Medium"]||(l["UTM Medium"]="email")));var v={},T={};for(var b in l)v[b+" [first touch]"]=l[b],T[b+" [last touch]"]=l[b];R.debug("Attribution params:"),R.debug(l),1==f&&(R.debug("..setting first touch params"),R.globalTraits=n(R.globalTraits,L(v))),R.debug("..setting last touch params"),R.globalTraits=n(R.globalTraits,T)}}function f(e){var t=[],i=window.optimizely;if(!i||!i.data)return t;var n=i.data,r=n.state,a=n.sections,o=r.activeExperiments;if(r.redirectExperiment){var s=r.redirectExperiment.experimentId,d=r.activeExperiments.indexOf(s);-1===d&&(o.push(s),R.overrideReferrer=r.redirectExperiment.referrer)}if(!o.length)return t;var u="Optimizely Experiments",g="Optimizely Variations",c=e[u],f=e[g];R.globalTraits[u]=c?"function"==typeof c.indexOf?c:[c]:[],R.globalTraits[g]=f?"function"==typeof f.indexOf?f:[f]:[];for(var l=0;l<o.length;l++){var p=o[l],h=r.variationIdsMap[p][0].toString(),m={"Experiment ID":p,"Experiment Name":n.experiments[p].name,"Experiment First View":!c||!c.indexOf||-1===c.indexOf(p),"Variation ID":h,"Variation Name":r.variationNamesMap[p]};-1===R.globalTraits[u].indexOf(p)&&R.globalTraits[u].push(p);var v=a[p];if(v){m["Section Name"]=v.name,m["Variation ID"]=v.variation_ids.join();for(var T=0;T<v.variation_ids.length;T++)-1===R.globalTraits[g].indexOf(v.variation_ids[T])&&R.globalTraits[g].push(v.variation_ids[T])}else-1===R.globalTraits[g].indexOf(h)&&R.globalTraits[g].push(h);t.push(["Optimizely Experiment Viewed",m])}return R.globalTraits[u].sort(),R.globalTraits[g].sort(),t}function l(){if(R.userId){R.debug("doIdentify(): received userId: "+R.userId);var e={},t=["name","email","createdAt"];for(var r in R.userTraits){for(var a=r.toLowerCase(),o="",s=0;s<t.length;s++)if(a===t[s].toLowerCase()){o=t[s];break}o||(o="User "+i(r)),e[o]=R.userTraits[r]}var d,u=n(R.globalTraits,e);R.adaptor.userId()?(d=R.adaptor.userId(),R.debug("Current userId: "+d)):(R.debug("Anonymous session until now - alias()"),R.adaptor.alias(R.userId),R.adaptor.identify("x")),R.debug("adaptor.identify("+R.userId+", [traits])"),R.userId!==d&&(u=n(u,L({createdAt:(new Date).toISOString()}))),R.adaptor.identify(R.userId,u),R.userId!==d&&(R.debug("userId != currentUserId - Login"),R.track("Login")),S("logged_out","",-100)}else R.adaptor.identify(R.globalTraits),R.detectLogout=void 0===R.detectLogout?void 0!==R.userId:R.detectLogout,R.detectLogout&&!k("logged_out")&&(R.debug("doIdentify(): detecting potential logout.."),R.adaptor.userId()&&(R.track("Logout"),S("logged_out",!0),R.debug("Logout")))}function p(e,t,i){R.debug("Viewed Page: ",[e,t,i]),"object"==typeof i?R.adaptor.page(e,t,R.getTraitsToSend(i)):"object"==typeof t?R.adaptor.page(e,R.getTraitsToSend(t)):t?R.adaptor.page(e,t,R.getTraitsToSend()):R.adaptor.page(e,R.getTraitsToSend())}function h(){T(v(["ready"]))}function m(){T(v())}function v(e){if(R.queue&&R.queue.length){if(!e||!e.length){var t=R.queue;return R.queue=[],t}for(var i=[],n=[],r=0;r<R.queue.length;r++)-1!==e.indexOf(R.queue[r][0])?i.push(R.queue[r]):n.push(R.queue[r]);return R.queue=n,i}}function T(e){for(;e&&e.length>0;){var t=e.shift(),i=t.shift();R[i]&&R[i].apply(R,t)}}function y(e){R.debug("Detected URL change: "+location.href),R.overrideReferrer=e||document.referrer,R.page=void 0;for(var t=R.detectPage(),i=0;i<C.length;i++)C[i](t);R.sniff()}function S(e,t,i,n){var r="";if(0!=i){var a=new Date;a.setTime(a.getTime()+24*i*60*60*1e3),r="expires="+a.toUTCString()}void 0===n&&(n=R.cookieDomain),document.cookie="sh_"+e+"="+t+"; "+r+";path=/"+(n?";domain="+n:"")}function k(e,t){void 0===t&&(t="sh_");for(var i=t+e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var a=n[r];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(i))return a.substring(i.length,a.length)}return""}function w(){for(var e="utm_source utm_medium utm_campaign utm_content utm_term".split(" "),t="",n={},r=0;r<e.length;++r)t=I(document.URL,e[r]),t.length&&(n["UTM "+i(e[r].slice(4))]=t);return n}function I(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i="[\\?&]"+t+"=([^&#]*)",n=new RegExp(i),r=n.exec(e);return null===r||r&&"string"!=typeof r[1]&&r[1].length?"":decodeURIComponent(r[1]).replace(/\+/g," ")}function L(e){var t=R.adaptor.userTraits(),i={};if("undefined"==typeof t)return e;for(var n in e)n in t||(i[n]=e[n]);return i}function D(e){for(var t=U(e),i=0;i<t.length;++i){var n="__tld__",r="."+t[i];if(S(n,1,0,r),k(n))return S(n,"",-100,r),r}return""}function U(e){var t=e.split("."),i=t[t.length-1],n=[];if(4==t.length&&parseInt(i,10)==i)return n;if(1>=t.length)return n;for(var r=t.length-2;r>=0;--r)n.push(t.slice(r).join("."));return n}var O,P,R=this,C=[];return this.adaptor=t,"object"!=typeof t?void d("adaptor not valid"):(!function(){var t={trackPages:null,page:null,trackAllPages:!1,detectURLChange:!0,detectHashChange:!1,domainsIgnore:["localhost","gtm-msr.appspot.com"],domainsIgnoreIPAddress:!0,domainsIgnoreSubdomains:["staging","test"],trackReferrerLandingPages:[],globalTraits:{},pageTraits:{},thisPageTraits:{},userId:void 0,userTraits:{},detectLogout:void 0,logToConsole:!1,silent:!1,sessionTimeout:30,overrideReferrer:void 0,queue:[],SNIPPET_VERSION:void 0};R.sniffed=!1;for(var i in t)void 0!==e[i]&&(t[i]=e[i]),R[i]=t[i];if(e.length&&e.pop)for(var n=0;n<b.length;n++)R.queue.unshift(e.pop());R.thisPageTraits["SiteHound library version"]=R.VERSION=g}(),this.sniff=this.done=function(){try{if(R.info("sniff()"),o(location.hostname))return R.info("Ignoring host: "+location.hostname),void(R.adaptor="disabled");if(k("dnt"))return R.info("Do-not-track cookie present - disabling."),void(R.adaptor="disabled");var e=!R.sniffed;if(u(),!e)return;m(),!R.detectURLChange&&!R.detectHashChange||O||(P=location.href,O=setInterval(function(){(R.detectHashChange?location.href!==P:location.href.replace(/#.*$/,"")!==P.replace(/#.*$/,""))&&(y(P),P=location.href)},1e3))}catch(t){this.trackError(t)}},this.deferUntilSniff=function(e,t){return R.sniffed?!1:(t=Array.prototype.slice.call(t),t.unshift(e),R.queue.push(t),R.debug("(Deferring "+e+"() until sniff)"),!0)},this.identify=function(e,t){R.debug("identify",[e,t]),"object"==typeof t?(R.userId=e,R.globalTraits=n(R.globalTraits,t)):"object"==typeof e?R.globalTraits=n(R.globalTraits,e):R.userId=e,R.sniffed&&l()},this.identifyOnce=function(e){R.deferUntilSniff("identifyOnce",arguments)||(R.debug("identifyOnce",e),R.adaptor.identify(L(e)))},this.detectPage=function(e){void 0===e&&(e=location.pathname);for(var t in R.trackPages){var i=R.trackPages[t];Array.isArray(i)||(i=[i]);for(var n=0;n<i.length;++n){var a=i[n];if("function"==typeof a.test){if(a.test(e))return R.debug("Detected page: "+t),t}else if("."===a[0]){if(e===location.pathname&&document.body.className.match(new RegExp("(?:^|\\s)"+r(a.slice(1))+"(?!\\S)")))return R.debug("Detected page: "+t),t}else if(e.replace(/\/$/,"").match(new RegExp("^"+r(a.replace(/\/$/,"")).replace(/\\\*/g,".*")+"$")))return R.debug("Detected page: "+t),t}}},this.getTraitsToSend=function(e){var t=n(R.globalTraits,R.thisPageTraits);return"object"==typeof e?n(t,e):t},this.info=function(e,t){R.silent||s(e,t)},this.debug=function(e,t){R.logToConsole&&s(e,t)},this.doNotTrack=function(e){e="undefined"==typeof e?!0:!!e,e?S("dnt","1",1e3):S("dnt","",-100),R.debug("doNotTrack",e?"true":"false")},this.debugMode=function(e){R.logToConsole=e="undefined"==typeof e?!0:!!e,e?S("logToConsole","1",1e3):S("logToConsole","",-100),R.debug("debugMode",e?"true":"false")},this.onURLChange=this.onUrlChange=function(e){"function"==typeof e?(this.debug("onURLChange()"),C.push(e)):d("onURLChange() called with something that isn't a function")},void a())}function i(e){return"string"==typeof e?e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):e}function n(e,t){var i={};for(var n in e)i[n]=e[n];for(var n in t)i[n]=t[n];return i}function r(e){return e.replace(/([\/*.?[\]()\-\|])/g,"\\$1")}function a(e,t){f[e]=t,t.prototype.klass=e}function o(e){var t,i;if("object"==typeof e)i=e;else{t=(e||"segment").toLowerCase()||"segment";try{var i=new f[t]}catch(n){return n("adaptor "+t+" could not be loaded"),void n(n.name+"; "+n.message)}}return i}function s(e,t){if(window.console&&console.log)try{"object"==typeof e?JSON&&JSON.stringify&&(e=c+JSON.stringify(e)):e=c+e,t&&JSON&&JSON.stringify&&(e=e+"("+JSON.stringify(t).slice(1).slice(0,-1)+")",t=null),console.log(e),t&&console.log(t)}catch(i){i(i.name+"; "+i.message)}}function d(e){window.console&&(console.error?console.error(c+e):console.log&&console.log(c+"[ERROR] "+e))}function u(e,t,i){for(var n=i||window,r=e.split("."),a=0;a<r.length;a++){if("undefined"==typeof n[r[a]])return void setTimeout(function(){u(e,t,i)},50);n=n[r[a]]}t()}var g="0.9.66",c="[SiteHound] ",f={};t.prototype.push=function(e){var t=e.shift();self[t]?self[t].apply(self,e):this.debug("Unrecognised method: "+t)},t.prototype.alias=function(e){this.deferUntilSniff("alias",arguments)||(this.debug("alias",[e]),this.adaptor.alias(e))},t.prototype.track=function(e,t){this.deferUntilSniff("track",arguments)||(t="object"==typeof t?this.getTraitsToSend(t):this.getTraitsToSend(),this.debug("track",[e,t]),this.adaptor.track(e,t))},t.prototype.trackOnce=function(e,t){if(!this.deferUntilSniff("trackOnce",arguments)){this.debug("trackOnce",[e,t]);var i=this.adaptor.userTraits();if(void 0===i["First "+e]){var n={};n["First "+e]=(new Date).toISOString(),this.adaptor.identify(n),this.track(e,t)}}},t.prototype.trackAndCount=function(e,t){if(!this.deferUntilSniff("trackAndCount",arguments)){this.debug("trackAndCount",[e,t]);var i=this.adaptor.userTraits(),n=1;i&&(n=i[e+" Count"]?parseInt(i[e+" Count"])+1:1);var r={};r["First "+e]=(new Date).toISOString(),this.identifyOnce(r);var a={};a[e+" Count"]=n,a["Last "+e]=(new Date).toISOString(),this.adaptor.identify(a),this.track(e,t)}},t.prototype.trackLink=function(e,t){if(!this.deferUntilSniff("trackLink",arguments)){var i={};e&&e.selector&&(i.selector=e.selector),e&&e.length&&(i.length=e.length),this.debug("trackLink",[i,t]),this.adaptor.trackLink(e,t,this.getTraitsToSend())}},t.prototype.trackForm=function(e,t){if(!this.deferUntilSniff("trackForm",arguments)){var i={};e&&e.selector&&(i.selector=e.selector),e&&e.length&&(i.length=e.length),this.debug("trackForm",[i,t]),this.adaptor.trackForm(e,t,this.getTraitsToSend())}},t.prototype.ready=function(e){if("function"==typeof e){var t=this.detectPage();this.debug("ready("+t+")"),e(t)}else d("ready() called with something that isn't a function")},t.prototype.getUserTraits=function(){return result=n(this.adaptor.userTraits(),this.userTraits),this.debug("getUserTraits() returned ",result),result},t.prototype.load=function(e){this.debug("load() called when already loaded"),e&&(this.adaptor=o(e),this.info("Updated adaptor to: "+e.klass))},t.prototype.trackDebugInfo=function(e){this.trackDebug(e,"info")},t.prototype.trackDebugWarn=function(e){this.trackDebug(e,"warn")},t.prototype.trackDebug=function(e,t){t||(t="info"),this.adaptor.track("Tracking Debug",{message:e,level:t,"SiteHound library version":this.VERSION}),this.debug("["+t+"] "+e)},t.prototype.trackError=function(e){this.adaptor.track("Tracking Error",{name:e.name,message:e.message,"SiteHound library version":this.VERSION}),e(e.name+"; "+e.message)},a("disabled",function(){this.ready=this.identify=this.track=this.trackLink=this.trackForm=this.page=this.alias=this.userId=this.userTraits=function(){}}),a("segment",function(){this.ready=function(e){u("analytics.ready",function(){analytics.ready(e)})},this.identify=function(e,t){analytics.identify(e,t)},this.track=function(e,t){analytics.track(e,t)},this.trackLink=function(e,t,i){analytics.trackLink(e,t,i)},this.trackForm=function(e,t,i){analytics.trackForm(e,t,i)},this.page=function(e,t,i){analytics.page(e,t,i)},this.alias=function(e){analytics.alias(e)},this.userId=function(){var e=analytics.user();return e?e.id():void 0},this.userTraits=function(){var e=analytics.user(),t=e.traits();return t}}),e()}();